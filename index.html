<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Card Game</title>
    <style>
        body {
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            overflow: hidden;
        }
        #game-container {
            position: relative;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
#instruction {
    font-size: 18px;
    font-weight: bold;
    max-width: 600px;
    text-align: center;
    white-space: pre-wrap;
    background-color: transparent;
    padding: 0;
    position: absolute;
    top: -15%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 1000;
}
#card-container {
    display: flex;
    justify-content: center;
    gap: 15px;
    position: relative;
    left: 140px; /* Shift 1.5 card widths (240px) to the right toward grey bricks */
}
.card-wrapper {
    width: 160px; /* Smaller width */
    height: 240px; /* Smaller height */
    position: relative;
}
.front {
    background: white;
    transform: rotateY(180deg);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px; /* Adjusted font size for smaller cards */
    text-align: center;
    padding: 15px;
    box-sizing: border-box;
}
        .card {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            perspective: 1000px;
            cursor: pointer;
        }
        .back, .front {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            transition: transform 0.5s ease-in-out;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .back {
background: repeating-linear-gradient(
        60deg,
        #1e90ff, /* Light blue base */
        #1e90ff 13px,
        #24588c 10px, /* Darker blue for pattern */
        #104e8b 20px
    ); /* Playing card texture: diagonal stripes */
            transform: rotateY(0deg);
        }
        .front {
            background: white;
            transform: rotateY(180deg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
        }
#card-container.reject-phase .front {
    background-color: #ff9999; /* Light red */
}
#card-container.select-phase .front {
    background-color: #abcfab; /* Light green */
        }
        .flipped .back {
            transform: rotateY(180deg);
        }
        .flipped .front {
            transform: rotateY(0deg);
        }
        .slide-down {
            transform: translateY(100vh);
            opacity: 0;
            transition: transform 0.5s ease-in-out, opacity 0.5s ease-in-out;
        }
        .slide-up {
            transform: translateY(-100vh);
            opacity: 0;
            transition: transform 0.5s ease-in-out, opacity 0.5s ease-in-out;
        }
        .selected {
            border: 4px solid green;
        }
#progress-container {
    position: absolute;
    left: 10px;
    top: 50%;
    transform: translateY(-50%);
    display: none; /* Hidden initially */
    grid-template-columns: repeat(12, 42px);
    gap: 2px;
    width: 518px;
    background-color: transparent;
}
#selected-container {
    position: absolute;
    top: calc(50% - 277px);
    left: 10px;
    width: 550px;
    max-height: 96px;
    display: none; /* Hidden initially */
    flex-direction: row;
    flex-wrap: wrap;
    justify-content: flex-start;
    align-content: flex-start;
    gap: 4px;
}
#rejected-container {
    position: absolute;
    left: 10px;
    top: calc(50% + 247px);
    width: 950px;
    max-height: 96px;
    display: none; /* Hidden initially */
    flex-direction: row;
    flex-wrap: wrap;
    justify-content: flex-start;
    align-content: flex-start;
    gap: 4px;
    z-index: 500;
}
#neither-container {
    position: absolute;
    right: 10px;
    top: calc(50% - 277px);
    width: 220px;
    height: auto;
    display: none; /* Hidden initially */
    flex-direction: row-reverse;
    flex-wrap: wrap;
    justify-content: flex-start;
    align-content: flex-start;
    gap: 4px;
    overflow: visible;
}
        .progress-icon {
            width: 40px;
            height: 20px;
            background-color: #ADD8E6;
            border-radius: 4px;
            position: relative;
            cursor: pointer;
        }
.progress-icon:hover::after {
    content: attr(title);
    position: absolute;
    background-color: #333;
    color: white;
    padding: 5px;
    border-radius: 5px;
    top: -30px;
    left: 0; /* Left-justified for blue bricks */
    white-space: nowrap;
    z-index: 1000;
}
.selected-icon {
    width: 40px;
    height: 20px;
    background-color: #abcfab; /* Light green */
    border-radius: 4px;
    margin: 2px;
    box-sizing: border-box;
    position: relative; /* Ensure dot positions relative to brick */
}
.rejected-icon {
    width: 40px;
    height: 20px;
    background-color: #ff9999; /* Light red */
    margin: 2px;
    border-radius: 4px;
    box-sizing: border-box;
    position: relative; /* Ensure dot positions relative to brick */
}
        .neither-icon {
            width: 40px;
            height: 20px;
            background-color: #D3D3D3;
            margin: 2px;
            border-radius: 4px;
            box-sizing: border-box;
            background-image: linear-gradient(45deg, rgba(0,0,0,0.1) 25%, transparent 25%, transparent 50%, rgba(0,0,0,0.1) 50%, rgba(0,0,0,0.1) 75%, transparent 75%, transparent);
            background-size: 4px 4px;
            position: relative; /* Ensure dot positions relative to brick */
        }
        .hidden {
            display: none;
        }
        .temp-icon {
            position: fixed;
            z-index: 1000;
            transition: left 0.5s ease-in-out, top 0.5s ease-in-out, width 0.5s ease-in-out, height 0.5s ease-in-out, opacity 0.5s ease-in-out;
            pointer-events: none;
            display: block;
        }
        #undo-button {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            bottom: -50px;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            background-color: #ddd;
            border: none;
            cursor: pointer;
            display: none;
        }
        #auto-progress {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            bottom: -100px;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            background-color: #ddd;
            border: none;
            cursor: pointer;
        }
        #results-container {
            display: none;
            font-size: 16px;
            font-family: monospace;
            justify-content: left;
            align-items: center;
            min-height: 100vh;
            width: 100%;
            text-align: left;
        }
        #timer-canvas {
            margin: 10px;
            position: absolute;
            top: calc(50% - 230px); /* Higher to be above instruction */
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            display: block;
            cursor: pointer; /* Indicate clickability */
        }
        #timer-label {
            font-size: 14px;
            color: #000;
            position: absolute;
            top: calc(50% - 260px); /* Above timer */
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            display: none; /* Hidden by default */
        }

        #continue-button {
            padding: 10px 20px;
            font-size: 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 5px;
            position: absolute;
            top: calc(50% + 120px);
            left: 50%;
            transform: translateX(-50%);
            z-index: 1200;
            display: none;
        }
        .clickable {
            cursor: pointer;
            position: relative;
        }
        .rejected-icon.marked::after,
        .selected-icon.marked::after,
        .neither-icon.marked::after {
            content: '';
            position: absolute;
            top: 2px;
            right: 2px;
            width: 8px;
            height: 8px;
            background-color: #000000; /* Black dot for marking */
            border-radius: 50%;
        }
.tooltip {
    position: absolute;
    background-color: #fff;
    color: #000;
    border: 1px solid #000;
    padding: 5px;
    border-radius: 5px;
    top: -30px; /* Aligned with blue brick tooltip */
    z-index: 2000;
    opacity: 0;
    transition: opacity 0.2s ease-in 0.2s;
    pointer-events: none;
    white-space: nowrap;
}
.rejected-icon:hover .tooltip,
.selected-icon:hover .tooltip {
    left: 0; /* Left-justified for red and green bricks */
    text-align: left;
    opacity: 1;
}
.neither-icon:hover .tooltip {
    right: 0; /* Right-justified for grey bricks */
    text-align: right;
    opacity: 1;
}
#selected-container .neither-icon .tooltip,
#rejected-container .neither-icon .tooltip,
#neither-container .neither-icon .tooltip {
    color: #808080 !important; /* Mid-grey for grey brick tooltips */
}

    </style>
</head>
<body>
    <div id="game-container">
        <div id="progress-container"></div>
        <div id="selected-container"></div>
        <div id="instruction">Click anywhere to start the game</div>
        <div id="timer-label">Click to add 60s</div>
        <canvas id="timer-canvas" width="100" height="100" class="hidden"></canvas>
<div id="card-container" class="hidden" style="display: none;">
    <!-- Cards will be dynamically created after the second "Continue" click -->
     </div>
<button id="undo-button">Bring back last card</button>
<button id="reverse-button" style="position: absolute; top: -20%; left: calc(50% + 50px); padding: 10px 20px; border-radius: 20px;
font-size: 16px; font-weight: bold; background-color: #abcfab; border: none; cursor: pointer;
display: none; z-index: 1000;">Reverse Sentiment</button>
<button id="auto-progress" style="position: absolute; left: 50%; transform: translateX(-50%); bottom: -100px; padding: 5px 15px; border-radius: 20px; font-size: 14px; background-color: #ddd; border: none; cursor: pointer;">Auto Progress</button>
        <button id="continue-button">Continue</button>
        <button id="copy-button" style="display: none; padding: 10px 20px; font-size: 16px; background-color: #4CAF50; color: white; border: none; cursor: pointer; border-radius: 5px; position: absolute; top: calc(50% + 180px); left: 50%; transform: translateX(-50%); z-index: 1200;">Click to Copy Results</button>
        <div id="rejected-container"></div>
        <div id="neither-container"></div>
    </div>
    <div id="results-container"></div>
    <script>
        const questionsData = [
"People have always been there to help me handle my feelings.|People have not been there to help me handle my feelings.|ed",
"I have gotten enough love and attention.|I have not gotten enough love and attention.|ed",
"Mostly, I have had someone to depend on for advice and help with how I feel.|Mostly, I have not had someone to depend on for advice and help with how I feel.|ed",
"I have mostly had someone to look after me, share themself with me, or care deeply about what happens to me.|I have mostly not had someone to look after me, share themself with me, or care deeply about what happens to me.|ed",
"I have usually had someone who wanted to get close to me and spend a lot of time with me.|I have not or rarely had someone who wanted to get close to me and spend a lot of time with me.|ed",
"People have mostly been there to give me warmth and kindness.|People have mostly not been there to give me warmth and kindness.|ed",
"For much of my life, I have mostly felt that I am special to someone.|For much of my life, I have not felt that I am special to someone.|ed",
"I have usually had someone who really listens to me and is tuned into my true needs and feelings.|I have usually not had someone who really listens to me or is tuned into my true needs and feelings.|ed",
"I have usually had a strong person to give me advice or direction when I need it.|I have rarely had a strong person to give me advice or direction when I need it.|ed",
"I don't tend to worry or think much about the fact that the people I love will die at some time.|I worry that the people I love will die soon, even though there is little medical reason for me to worry.|ab",
"I am pretty secure with the people I am close to, I never think about them leaving me.|I find myself clinging to people I am close to, because I am afraid they will leave me.|ab",
"I never worry that people I feel close to will leave me or abandon me.|I worry that people I feel close to will leave me or abandon me.|ab",
"I feel that I have a stable base of support from someone who cares about me.|I feel that I lack a stable base of support from someone who cares about me.|ab",
"I generally feel that important relationships will last.|I do not feel that important relationships will last; I expect them to end.|ab",
"I tend to find partners who can be there for me in a committed way.|I feel addicted to partners who cannot be there for me in a committed way.|ab",
"In the end, I will have people around me.|In the end, I will be alone.|ab",
"When I feel someone I care for pulling away from me, I can handle it fine.|When I feel someone I care for pulling away from me, I can do crazy things.|ab",
"When I am worried about people leaving me, I can give them the space they need.|Sometimes I am so worried about people leaving me that I drive them away.|ab",
"I am quite happy when someone leaves me alone, even for a longer periods of time.|I become upset when someone leaves me alone, even for a short period of time.|ab",
"I can count on people who I should be able to rely on to be there when I need them.|I cannot count on people who I should be able to rely on to be there when I need them.|ab",
"When I let myself get really close to other people, it is because I can usually judge that they will be there when I need them.|I cannot let myself get really close to other people, because I cannot be sure they will always be there.|ab",
"It seems that the important people in my life are stable fixtures.|It seems that the important people in my life are always coming and going.|ab",
"I never think that the people I love might find someone else they prefer or leave me.|I worry a lot that the people I love will find someone else they prefer and leave me.|ab",
"People close to me have been predictable: they have had stable tempraments, seldom angry, upset, selfish or fighting.|People close to me have been unpredictable: one moment they are nice to me, the next they are angry, upset, selfish or fighting.|ab",
"I am pretty self-reliant.  I never worry about losing anyone.|I need other people so much that I worry about losing them.|ab",
"I am happy expressing what I really feel and confident people close to me will accept me regardless.|I cannot be myself or express what I really feel, or people will leave me.|ab",
"I do not think that people usually will try to take advantage of me.|I feel that people will take advantage of me.|ma",
"I seldom feel that I have to protect myself from other people.|I often feel that I have to protect myself from other people.|ma",
"I am happy to be open about who I am in the presence of other people, people are generally kind and accepting.|I am reluctant to let my guard down in the presence of other people, or else they will plan to hurt me.|ma",
"If someone acts nicely towards me, I assume that they are just being kind.|If someone acts nicely towards me, I assume that they must be after something.|ma",
"If someone betrays me that would be very unusual, it seldom happens.|It is only a matter of time before someone betrays me.|ma",
"Most people think about others and want to help.|Most people only think about themselves.|ma",
"I tend in general to trust people.|I have a great deal of difficulty trusting people.|ma",
"I am seldom suspicious of other peoples motives.|I am quite suspicious of other peoples motives.|ma",
"People are generally honest; they are usually what they appear to be.|Other people are rarely honest; they are usually not what they appear.|ma",
"I don't usually think about other peoples ulterior motives.|I am usually on the lookout for peoples ulterior motives.|ma",
"If I think someone is out to hurt me, I try to make up with them or avoid them.|If I think someone is out to hurt me, I try to hurt him or her first.|ma",
"People don't have to prove themselves to me.  I generally trust people until proven otherwise.|People usually have to prove themselves to me before I can trust them.|ma",
"I don't believe in setting up tests for other people, I trust that they are telling me the truth and are well-intentioned.|I set up tests for other people, to see if they are telling me the truth and are well-intentioned.|ma",
"Co-operation is much more important than controlling people.  I believe in working with people.|I subscribe to the belief: Control or be controlled.|ma",
"I feel forgiveness when I think about the ways I have been mistreated by other people during my life.|I get angry when I think about the ways I have been mistreated by other people during my life.|ma",
"During my life, those close to me have supported me even when it didn't suit their own purposes.|During my life, those close to me have taken advantage of me or used me for their own purposes.|ma",
"Important people in my life have never tried to hurt my feelings or physically, or sexually abused me.|Important people in my life have often tried to hurt my feelings or physically, or sexually abused me.|ma",
"I fit in.|I do not fit in.|si",
"I am pretty similar to many other people.|I am fundamentally different from other people.|si",
"I know where I belong; I am happy in my group.|I do not belong; I am a loner.|si",
"I seldom feel alienated from other people.|I feel alienated from other people.|si",
"I almost never feel isolated and alone.|I feel isolated and alone.|si",
"I usually confident within the groups I am part of.|I always feel on the outside of groups.|si",
"Some people I am close to really understand me.|No one really understands me.|si",
"My family was pretty similar to the families around us.|My family was always different from the families around us.|si",
"I never feel as if I am an alien.|I sometimes feel as if I am an alien.|si",
"If I disappeared tomorrow a lot of people would be affected.|If I disappeared tomorrow, no one would notice.|si",
"Even with all my defects, I am confident I am a lovable person.|No one I desire could love me once they see my defects.|ds",
"Despite my deepest secrets, I am confident that someone I desire would still want to be close to me.|No one I desire would want to stay close to me if they knew the real me.|ds",
"In general people are not born flawed and defective. I was not born that way.|I am just born flawed and defective.|ds",
"I expect I will be able to get a significant man or woman to respect me or feel that I am worthwhile.|No matter how hard I try, I doubt I will be able to get a significant man or woman to respect me or feel that I am worthwhile.|ds",
"I am worthy of the love, attention, and respect of others.|I am unworthy of the love, attention, and respect of others.|ds",
"I feel that I am lovable.|I feel that I am not lovable.|ds",
"I am acceptable in my essence. I want others to see the real me.|I am unacceptable in very basic ways. I do not want others to see the real me.|ds",
"If others found out about any of my defects that’s fine with me, its part of life.|If others found out about my basic defects, I could not face them.|ds",
"When people like me I can understand why.|When people like me, I feel I am fooling them.|ds",
"I tend not to spend time with people who are very critical of me or reject me.|Often I find that I want to spend time with people who are very critical of me or reject me.|ds",
"I do not have inner secrets that I want to hide from people close to me.|I have inner secrets that I do not want people close to me to find out.|ds",
"If my parents ever treated me coldly or did not love me enough, that is their responsibility not mine.|It is my fault that my parents could not love me enough.|ds",
"I try to let people know the real me.|I do not let people know the real me.|ds",
"I do not worry at all that my defects will be exposed.|One of my greatest fears is that my defects will be exposed.|ds",
"I can understand how someone could love me.|I cannot understand how anyone could love me.|ds",
"Almost everything I do at work is as good as other people can do.|Almost nothing I do at work is as good as other people can do.|fa",
"I am pretty successful when it comes to achievement.|I am incompetent when it comes to achievement.|fa",
"Most other people are not as capable as I am at work or in other things I do.|Most other people are more capable than I am at work or in other things I do.|fa",
"I am a success.|I am a failure.|fa",
"I am just as talented in my work as most people are at theirs.|I am not as talented in my work as most people are at theirs.|fa",
"I am just as intelligent as most people when it comes to work.|I am not as intelligent as most people when it comes to work.|fa",
"I am unbothered by any failures or inadequacies at work.|I am humiliated by my failures and inadequacies at work.|fa",
"I seldom feel embarrassed around other people as a result of not measuring up to them in terms of what I have done.|I often feel embarrassed around other people, because I do not measure up to them in terms of what I have done.|fa",
"If I compare the things I have done with others, I usually feel that I am more successful.|I often compare the things I have done with others and feel that they are more successful.|fa",
"I feel fully capable of getting by on my own in everyday life.|I do not feel capable of getting by on my own in everyday life.|di",
"I do not need other people to help me get by.|I need other people to help me get by.|di",
"I feel I can cope well by myself.|I do not feel I can cope well by myself.|di",
"I believe that I can take care of myself better than other people can take care of me.|I believe that other people can take care of me better than I can take care of myself.|di",
"I have no problem tackling new tasks outside of work and seldom need anyone to guide me.|I have trouble tackling new tasks outside of work unless I have someone to guide me.|di",
"I do not think of myself as a dependent person when it comes to getting through the days and weeks.|I think of myself as a dependent person when it comes to getting through the days and weeks.|di",
"I usually succeed in most things I try, even outside of work.|I screw up everything I try, even outside of work.|di",
"I am competent in most areas of life.|I am inept in most areas of life.|di",
"If I trust my own judgment in everyday situations I will make the right decision.|If I trust my own judgment in everyday situations I will make the wrong decision.|di",
"I have common sense.|I lack common sense.|di",
"My judgment can be relied on in everyday situations.|My judgment cannot be relied on in everyday situations.|di",
"I feel confident about my ability to solve everyday problems.|I do not feel confident about my ability to solve everyday problems.|di",
"I seldom need someone to rely on to give me advice about practical issues.|I need someone I can rely on to give me advice about practical issues.|di",
"I feel fully adult when it comes to handling the problems of everyday life.|I feel more like a child than an adult when it comes to handling the problems of everyday life.|di",
"I find the responsibilities of everyday life easy to handle.|I find the responsibilities of everyday life overwhelming.|di",
"I almost never have the feeling that something bad is about to happen.|I cannot seem to escape the feeling that something bad is about to happen.|vu",
"I don't tend to think that a disaster (criminal, financial, or medical) could strike at any moment.|I feel that a disaster (criminal, financial, or medical) could strike at any moment.|vu",
"I never worry about becoming a street person or vagrant.|I worry about becoming a street person or vagrant.|vu",
"I never worry about being attacked.|I worry about being attacked.|vu",
"I do not take any precautions to avoid getting sick or hurt.|I take great precautions to avoid getting sick or hurt.|vu",
"I do not worry or even think about developing a serious illness.|I worry that I am developing a serious illness even though nothing has been diagnosed.|vu",
"I am not a fearful person.|I am a fearful person.|vu",
"I do not worry much about the bad things happening in the world like crime or pollution.|I worry a lot about the bad things happening in the world like crime or pollution.|vu",
"I never think that I might go crazy.|I feel that I might go crazy.|vu",
"I never feel that I am going to have an anxiety attack.|I often feel that I am going to have an anxiety attack.|vu",
"I never worry or think that I might have a heart attack or cancer until there is medical reason to.|I worry that I might have a heart attack or cancer even though there is little medical reason to.|vu",
"I feel the world is a safe place.|I feel the world is a dangerous place.|vu",
"I have been able to separate myself from my parents, I make my own decisions.|I have not been able to separate myself from my parents the way other people my age seem to.|eu",
"My parents and I have appropriate separation from each others lives and problems.|My parents and I tend to be overinvolved in each others lives and problems.|eu",
"My parents and I are happy to keep our intimate details from each other, appropriate distance is healthy.|It is very difficult for my parents and me to keep intimate details from each other, without feeling betrayed or guilty.|eu",
"I speak to my parents regularly but if there is a gap in communication that is fine on both sides.|My parents and I have to speak to each other almost every day, or else one of us feels guilty, disappointed, or alone.|eu",
"I have a separate identity from my parents and partner.|I often feel that I do not have a separate identity from my parents or partner.|eu",
"My parents are living their lives — I am living my own, separate life.|I often feel as if my parents are living through me — I do not have a life of my own.|eu",
"It is normal for me to maintain some distance from the people I am really close to; I have no trouble keeping a separate sense of myself.|It is very difficult for me to maintain any distance from the people I am really close to; I have trouble keeping any separate sense of myself.|eu",
" I know who I am and what I want, my relationship with my partner or parents does not affect that.|I am so involved with my partner or parents that I do not really know who I am or what I want.|eu",
"I have no trouble separating my point of view or opinion from that of my parents or partner.|I have trouble separating my point of view or opinion from that of my parents or partner.|eu",
"I feel that I have appropriate privacy when it comes to my parents or partner.|I feel that I have no privacy when it comes to my parents or partner.|eu",
"I feel that my parents would fine if I lived away from them on my own.|I feel that my parents would be hurt by me living away from them on my own.|eu",
"I tell other people what I want, negotiation is healthy.|I let other people have their way, because I fear what might happen.|sb",
"I believe that if I do what I want, that is a reasonable thing to do.|I believe that if I do what I want, I am only asking for trouble.|sb",
"I do not have to give in to other peoples wishes, they will not retaliate or reject me in some way.|I have no choice but to give in to other peoples wishes, or else they will retaliate or reject me in some way.|sb",
"In relationships, I do not let the other person have the upper hand.|In relationships, I let the other person have the upper hand.|sb",
"I have not let others make choices for me, I know what I want for myself.|I have let others make choices for me, so I really do not know what I want for myself.|sb",
"I feel the major decisions in my life were my own.|I feel the major decisions in my life were not really my own.|sb",
"I do not worry about pleasing other people, I do not worry they will reject me.|I worry about pleasing other people, so they will not reject me.|sb",
"I have no trouble demanding that my rights be respected and that my feelings be considered.|I have trouble demanding that my rights be respected and that my feelings be considered.|sb",
"I am happy to show my anger directly, I do not try to get back at people in little ways.|I get back at people in little ways instead of showing my anger directly.|sb",
"I do not try to avoid confrontations if they are appropriate.|I will go to greater lengths than most people to avoid confrontations.|sb",
"I do not feel guilty to put my needs forward as important as other peoples.|I put others needs before my own, or else I feel guilty.|ss",
"I tend not to feel guilty if I let other people down or disappoint them.|I feel guilty when I let other people down or disappoint them.|ss",
"I get more from other people than I give back in return.|I give more to other people than I get back in return.|ss",
"I not usually the one who ends up taking care of the people I am close to.|I am the one who usually ends up taking care of the people I am close to.|ss",
"Even if I loved someone very much, there are limits to what I could put up with.|There is almost nothing I could not put up with if I loved someone.|ss",
"I am a good person because I take care of myself first, to let me then think of others.|I am a good person because I think of others more than of myself.|ss",
"At work, I am seldom the one to volunteer to do extra tasks or to put in extra time.|At work, I am usually the one to volunteer to do extra tasks or to put in extra time.|ss",
"When I am very busy, I have no problem ignoring others problems until I have time.|No matter how busy I am, I can always find time for others.|ss",
"I have specific expectations and needs, my needs are appropriate.|I can get by on very little, because my needs are minimal.|ss",
"I can be happy even when those around me are not.|I am only happy when those around me are happy.|ss",
"I always make time for myself before also taking time to do things for the people that I care about.|I am so busy doing for the people that I care about that I have little time for myself.|ss",
"I have not usually been the one who listens to everyone elses problems.|I have always been the one who listens to everyone elses problems.|ss",
"I am happier to receive a present than to give one.|I am happier to give a present than to receive one.|ss",
"Other people see me as doing too much for myself and not enough for others.|Other people see me as doing too much for others and not enough for myself.|ss",
"I feel I give enough to others.|No matter how much I give, I feel it is never enough.|ss",
"If I do what I want, I usually feel comfortable with my choices.|If I do what I want, I feel very uncomfortable.|ss",
"It is not difficult for me to ask others to take care of my needs.|It is very difficult for me to ask others to take care of my needs.|ss",
"I do not worry about losing control of my actions.|I worry about losing control of my actions.|ei",
"I have self-control; I do not worry that I might hurt someone in any way even if I get very angry.|I worry that I might seriously physically or emotionally hurt someone if my anger gets out of control.|ei",
"I do not need to concentrate on controlling how I feel or act, I will not do something impetuous or bad.|I must control how I feel and be careful in how I act, or something bad is likely to happen.|ei",
"I do not tend to experience anger or resentment building up inside of me.|A lot of anger and resentment builds up inside of me that I do not express.|ei",
"I have no problem showing positive feelings to others (eg, being nice first, showing I care).|I am too self-conscious to show positive feelings to others (eg, being nice first, showing I care).|ei",
"I find it enjoyable to express my feelings to others.|I find it embarrassing to express my feelings to others.|ei",
"I find it easy to be warm or to start fun conversations without thinking about it first.|I find it hard to be warm or to start fun conversations without thinking about it first.|ei",
"I do not have to try  to control myself so much that people think I am unemotional.|I control myself so much that people think I am unemotional.|ei",
"People do not see me as uptight and know I am happy to show my feelings.|People see me as uptight and think that I do not show my feelings.|ei",
"I am happy to do a reasonable job; I do not need to be best all the time.|I must be the best at most of what I do; I cannot accept second best.|us",
"I am not a perfectionist|I strive to keep almost everything in perfect order.|us",
"I don't worry overmuch about my appearance.|I must look my best most of the time.|us",
"Good enough is sufficient|I try to do my best; I cannot settle for good enough.|us",
"There is time for both relaxation and to accomplish my goals.|I have so much to accomplish that there is almost no time to really relax.|us",
"What I am doing is good enough; I can get better but I'm not obsessed with it.|Almost nothing I do is quite good enough; I can always do better.|us",
"If I miss a few of my responsibilities, that is ok.|I must meet all my responsibilities.|us",
"I do not feel pressure for me to achieve and get things done.|I feel there is constant pressure for me to achieve and get things done.|us",
"I have a good balance between my relationships and my work.|My relationships suffer because I push myself so hard.|us",
"I take care of my health first, even if this impact my ability to do other things.|My health is suffering because I put myself under so much pressure to do well.|us",
"My pleasure and happiness is important, even if standards slip a bit sometimes.|I often sacrifice pleasure and happiness to meet my own standards.|us",
"When I make a mistake, I can learn from it and criticism is not useful.|When I make a mistake, I deserve strong criticism.|us",
"I do not feel on the hook for my mistakes, there are often valid reasons for the failure.|I cannot let myself off the hook easily or make excuses for my mistakes.|us",
"I am not a very competitive person.|I am a very competitive person.|us",
"I do not tend to put much emphasis on money or status.|I put a good deal of emphasis on money or status.|us",
"I do not have to be Number One, in terms of my performance.|I have to be Number One, in terms of my performance.|us",
"I can accept no for an answer when I want something from other people.|I have trouble accepting no for an answer when I want something from other people.|et",
"I tend not to get angry or irritable if I cannot get what I want.|I often get angry or irritable if I cannot get what I want.|et",
"I am similar to everyone else and should therefore accept the rules placed on other people.|I am special and should not have to accept many of the rules placed on other people.|et",
"It is reasonable for me to be constrained or kept from doing what I want when appropriate.|I hate to be constrained or kept from doing what I want.|et",
"I should follow the normal conventions and rules that other people do.|I feel that I should not have to follow the normal conventions and rules that other people do.|et",
"What I have to offer is of no greater value than the contributions of others.|What I have to offer is usually of greater value than the contributions of others.|et",
"I try not to put my needs ahead of the needs of others.|I usually put my needs ahead of the needs of others.|et",
"I am not so involved in my own plans and actions that I cannot find time to give to friends or family.|I find that I am so involved in my own plans and actions that I often do not have time to give to friends or family.|et",
"People do not find me to be very controlling about how things are done.|People tell me I am very controlling about how things are done.|et",
"I can accept it when people will not do what I ask of them.|I get irritated when people will not do what I ask of them.|et",
"I do not mind other people telling me what to do.|I cannot tolerate other people telling me what to do.|et",
"I have control over my drinking, eating, and other potentially problem behaviors.|I have difficulty getting myself to stop drinking, overeating, or other problem behaviors.|is",
"I can discipline myself to complete routine or boring tasks.|I cannot discipline myself to complete routine or boring tasks.|is",
"I do not carry through on impulses or express emotions that get me into trouble or hurt other people.|I tend to carry through on impulses and express emotions that get me into trouble or hurt other people.|is",
"If I cannot reach a goal, I can persist and keep working toward it.|If I cannot reach a goal, I become easily frustrated and give up.|is",
"I find it easy to put off what I want right now in order to get what I want in the future.|I find it hard to put off what I want right now in order to get what I want in the future.|is",
"Once I start to feel angry, I can usually control it.|Once I start to feel angry, I usually just cannot control it.|is",
"I do not overdo things, I know when things are bad for me and I stop.|I tend to overdo things, even though I know they are bad for me.|is",
"I do not get bored very easily.|I get bored very easily.|is",
"When tasks become difficult, I press on until I complete them.|When tasks become difficult, I usually stop and cannot complete them.|is",
"I can concentrate for a fair period on any task.|I cannot concentrate on anything for too long.|is",
"I can force myself to do things I do not enjoy, when I know it is for my own good.|I cannot force myself to do things I do not enjoy, even when I know it is for my own good.|is",
"I have control of my temper, slight offenses do not bother me.|I lose my temper at the slightest offense.|is",
"I have usually been able to stick to my resolutions.|I have rarely been able to stick to my resolutions.|is",
"I usually can hold back from showing people how I feel when appropriate to do so.|I usually cannot hold back from showing people how I feel, no matter what the cost may be.|is",
"I seldom do things without thinking that I later regret.|I often do things without thinking that I later regret.|is",
"It is not that important to me to be liked by almost everyone I know.|It is important to me to be liked by almost everyone I know.|as",
"I do not change myself depending on the people I am with, people should like me as I am.|I change myself depending on the people I am with, so they will like me more.|as",
"I do not try to fit in, I am who I am.|I try hard to fit in.|as",
"My feelings about myself are not based on how other people view me.|My feelings about myself are based mostly on how other people view me.|as",
"Having money and knowing important people is not a big part of making me feel worthwhile.|Having money and knowing important people make me feel worthwhile.|as",
"I do not spend a lot of time on my physical appearance to try to get people value me more.|I spend a lot of time on my physical appearance so people value me.|as",
"My successes are valuable to me whether or not other people notice them.|My successes are most valuable to me when other people notice them.|as",
"I am never so focused on fitting in that  I do not know who I am.|I am so focused on fitting in that sometimes I do not know who I am.|as",
"When setting my own goals, I seldom think about how others will view them.|When setting my own goals, I usually thinking about how others will view them.|as",
"When I look back at my life decisions, I see that getting other peoples approval was not part of the decision.|When I look back at my life decisions, I see that getting other peoples approval was an important part of the decision.|as",
"If I do not like someone, I do not care if they like me or not.|Even if I do not like someone, I still want him or her to like me.|as",
"I do not feel less important if I get less attention from others.|Unless I get a lot of attention from others, I feel less important.|as",
"When I am introduced, or make remarks at a meeting, the respect and admiration that follows is unimportant to me.|When I am introduced, or make remarks at a meeting, I enjoy the respect and admiration that follows.|as",
"Lots of praise and compliments have little impact on how I feel about myself.|Lots of praise and compliments make me feel like a worthwhile person.|as",
"When things seem to be going well, I feel that it is part of building something lasting.|Even when things seem to be going well, I feel that it is only temporary.|np",
"If something good happens, I do not worry that something bad is likely to follow.|If something good happens, I worry that something bad is likely to follow.|np",
"In any project something will almost always go wrong, you can fix it so don't worry.|You cannot be too careful; something will almost always go wrong.|np",
"The money I have worked for is secure and I will not lose it.|No matter how hard I work, I worry that I could lose all my money.|np",
"I will make some wrong decisions but they are not a disaster and can be changed.|I worry that a wrong decision could lead to disaster.|np",
"I do not obsess over minor decisions, any mistake can be easily fixed.|I can obsess over minor decisions, because making a mistake seems so serious.|np",
"It is better assuming that things will work out for me, if things go wrong I can fix them and it will work in the end.|It is better assuming that things will not work out for me, that way I do not feel disappointed if things go wrong.|np",
"I focus more on the positive aspects of life and of events than on the negative.|I focus more on the negative aspects of life and of events than on the positive.|np",
"I tend to be optimistic.|I tend to be pessimistic.|np",
"People close to me do not consider me a worrier.|People close to me consider me a worrier.|np",
"If people get enthusiastic about something, I enjoy it and join in on their enthusiasm.|If people get too enthusiastic about something, I become uncomfortable and feel like warning them of what could go wrong.|np",
"If I make a mistake, I deserve to be given a second chance.|If I make a mistake, I deserve to be punished.|pu",
"If I do not try my hardest, I should expect to still do ok.|If I do not try my hardest, I should expect to lose out.|pu",
"Everyone makes a mistakes.  If I make one that’s ok.|There is no excuse if I make a mistake.|pu",
"People who do not pull their own weight should be understood and supported to do better.|People who do not pull their own weight should get punished in some way.|pu",
"I usually accept the excuses other people make, their reasons are often good and people mostly want to do their best.|Usually I do not accept the excuses other people make. They are just not willing to accept responsibility and suffer what happens next.|pu",
"If I do not do the job, I should be supported to do the job better, not punished.|If I do not do the job, I should suffer whatever happens next.|pu",
"I do not usually think about my mistakes, if I do it is with curiosity and to learn.|I often think about my mistakes and feel angry with myself.|pu",
"When people do something bad, I am happy to say, Forgive and forget.|When people do something bad, I have trouble applying the phrase, Forgive and forget.|pu",
"When someone has apologized, I do not hold a grudge.|I hold grudges, even after someone has apologized.|pu",
"If I think someone has been let off the hook too easily, I don't worry about it.|I get upset when I think someone has been let off the hook too easily.|pu",
"When people make excuses for themselves or blame other people for their problems I am sympathetic.|I get angry when people make excuses for themselves, or blame other people for their problems.|pu",
"When I make a mistake it matters why; when I do something wrong responsibility should be shared.|It does not matter why I make a mistake; when I do something wrong, I should pay the price.|pu",
"I do not beat-up on myself for things I screw up.|I beat-up on myself a lot for things I screw up.|pu",
"I am a not bad person and do not deserve to be punished|I am a bad person who deserves to be punished.|pu"
        ];
        const categoryData = [
            {group: "DAR", category: "ds", descriptor: "I tend to hide the real me", total: 15},
            {group: "DAR", category: "ed", descriptor: "I want to be wanted", total: 9},
            {group: "DAR", category: "ei", descriptor: "My feelings are dangerous", total: 9},
            {group: "DAR", category: "ma", descriptor: "Trusting people is full of risk", total: 17},
            {group: "DAR", category: "si", descriptor: "I often feel on the outside", total: 10},
            {group: "ERS", category: "as", descriptor: "Being liked is extremely important", total: 14},
            {group: "ERS", category: "np", descriptor: "Success is short and temporary", total: 11},
            {group: "ERS", category: "pu", descriptor: "Forgiveness is weak, consequences must follow", total: 14},
            {group: "ERS", category: "ss", descriptor: "My time and feelings matter less", total: 17},
            {group: "ERS", category: "us", descriptor: "Only perfection is good enough", total: 16},
            {group: "IAP", category: "ab", descriptor: "I'm often left out or let down", total: 17},
            {group: "IAP", category: "di", descriptor: "I am very dependent on others", total: 15},
            {group: "IAP", category: "em", descriptor: "I'm very bound up in others lives", total: 11},
            {group: "IAP", category: "fa", descriptor: "I fail much more than I succeed", total: 9},
            {group: "IAP", category: "sb", descriptor: "Others have more power than I do", total: 10},
            {group: "IAP", category: "vh", descriptor: "Disaster is just around the corner", total: 12},
            {group: "IL", category: "et", descriptor: "I know best so just do it", total: 11},
            {group: "IL", category: "is", descriptor: "What I want right now takes over", total: 15}
        ];
        const questionsByCategory = {};
        questionsData.forEach(line => {
            const [question, opposite, category] = line.split('|');
            if (question && category) {
                if (!questionsByCategory[category]) {
                    questionsByCategory[category] = [];
                }
                questionsByCategory[category].push({ question, opposite });
            }
        });
        const greenSelections = {};
        const redSelections = {};
        const allSelections = [];
        const remainingQuestionsByCategory = JSON.parse(JSON.stringify(questionsByCategory));
        categoryData.forEach(({category}) => {
            greenSelections[category] = 0;
            redSelections[category] = 0;
        });
        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }
const totalSets = Math.floor(232 / 5);
let currentSetIndex = 0;
let selectedCards = [];
let removeFromTop = true;
let isFlipped = false;
let selectionCount = 0;
let isAnimating = false;
let updatePhase = null;
let timerInterval = null;
let cards = [];
const instruction = document.getElementById('instruction');
const progressContainer = document.getElementById('progress-container');
const timerCanvas = document.getElementById('timer-canvas');
const continueButton = document.getElementById('continue-button');
const reverseButton = document.getElementById('reverse-button');
        const ctx = timerCanvas.getContext('2d');
const allQuestions = [];
for (const category in questionsByCategory) {
    allQuestions.push(...questionsByCategory[category].map(q => ({ text: q.question, opposite: q.opposite, category })));
}
shuffle(allQuestions);
// Delay creation of blue bricks until second "Continue" click

function drawTimer(seconds, totalTime = 10) {
    ctx.clearRect(0, 0, timerCanvas.width, timerCanvas.height);
    const centerX = timerCanvas.width / 2;
    const centerY = timerCanvas.height / 2;
    const radius = 40;
    ctx.beginPath();
    ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
    ctx.fillStyle = '#ddd';
    ctx.fill();
    ctx.beginPath();
    const progress = seconds / totalTime;
    ctx.arc(centerX, centerY, radius, -Math.PI / 2, -Math.PI / 2 + 2 * Math.PI * (1 - progress), false);
    ctx.strokeStyle = updatePhase === 'red' ? '#ec5f02' : updatePhase === 'green' ? '#b301b3' : '#D3D3D3'; /* Red, Green, Grey */
    ctx.lineWidth = 10;
    ctx.stroke();
    ctx.font = '16px Arial';
    ctx.fillStyle = '#000';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(`${seconds}s`, centerX, centerY);
}
function getNextSet() {
    const availableQuestions = [];
    for (const category in remainingQuestionsByCategory) {
        availableQuestions.push(...remainingQuestionsByCategory[category].map(q => ({ text: q.question, opposite: q.opposite, category })));
    }
    if (availableQuestions.length < 5 && availableQuestions.length > 0) {
        return availableQuestions.splice(0, availableQuestions.length);
    }
    if (availableQuestions.length === 0) return null;
    shuffle(availableQuestions);
    const set = [];
    const availableCategories = Object.keys(remainingQuestionsByCategory).filter(c => remainingQuestionsByCategory[c].length > 0);
    if (availableCategories.length >= 5) {
        const affinity = {};
        for (const category in remainingQuestionsByCategory) {
            const green = greenSelections[category] || 0;
            const red = redSelections[category] || 0;
            affinity[category] = green - red;
        }
        let possibleQuintets = [];
        for (let i = 0; i < availableCategories.length; i++) {
            for (let j = i + 1; j < availableCategories.length; j++) {
                for (let k = j + 1; k < availableCategories.length; k++) {
                    for (let m = k + 1; m < availableCategories.length; m++) {
                        for (let n = m + 1; n < availableCategories.length; n++) {
                            const quintet = [availableCategories[i], availableCategories[j], availableCategories[k], availableCategories[m], availableCategories[n]];
                            const score = Math.abs(affinity[quintet[0]] - affinity[quintet[1]]) +
                                          Math.abs(affinity[quintet[0]] - affinity[quintet[2]]) +
                                          Math.abs(affinity[quintet[0]] - affinity[quintet[3]]) +
                                          Math.abs(affinity[quintet[0]] - affinity[quintet[4]]) +
                                          Math.abs(affinity[quintet[1]] - affinity[quintet[2]]) +
                                          Math.abs(affinity[quintet[1]] - affinity[quintet[3]]) +
                                          Math.abs(affinity[quintet[1]] - affinity[quintet[4]]) +
                                          Math.abs(affinity[quintet[2]] - affinity[quintet[3]]) +
                                          Math.abs(affinity[quintet[2]] - affinity[quintet[4]]) +
                                          Math.abs(affinity[quintet[3]] - affinity[quintet[4]]);
                            possibleQuintets.push({quintet, score});
                        }
                    }
                }
            }
        }
        if (possibleQuintets.length > 0) {
            possibleQuintets.sort((a, b) => b.score - a.score);
            const bestQuintet = possibleQuintets[0].quintet;
            for (const category of bestQuintet) {
                const questions = remainingQuestionsByCategory[category];
                const idx = Math.floor(Math.random() * questions.length);
                const question = questions.splice(idx, 1)[0];
                set.push({ text: question.question, opposite: question.opposite, category });
            }
            return set;
        }
    }
    for (let i = 0; i < 5 && availableQuestions.length > 0; i++) {
        const question = availableQuestions.shift();
        set.push(question);
        remainingQuestionsByCategory[question.category] = remainingQuestionsByCategory[question.category].filter(q => q.question !== question.text);
    }
    return set;
}

function animateCardToContainer(card, containerId, iconClass, text, opposite, category, callback) {
    console.log(`animateCardToContainer: Adding ${iconClass} to ${containerId}, text=${text}, category=${category}`);
    const initialRect = card.getBoundingClientRect();
    const frontClone = card.querySelector('.front').cloneNode(true);
    frontClone.className = 'temp-icon';
    frontClone.style.left = initialRect.left + 'px';
    frontClone.style.top = initialRect.top + 'px';
    frontClone.style.width = initialRect.width + 'px';
    frontClone.style.height = initialRect.height + 'px';
    frontClone.style.opacity = '1';
    document.body.appendChild(frontClone);
    const actualIcon = document.createElement('div');
    actualIcon.className = iconClass;
    actualIcon.dataset.tooltip = iconClass === 'rejected-icon' ? opposite : text;
    actualIcon.dataset.opposite = opposite;
    actualIcon.dataset.category = category;
    actualIcon.dataset.text = text;
    actualIcon.style.visibility = 'hidden';
    const container = document.getElementById(containerId);
    container.appendChild(actualIcon);
    // Add tooltip for red, green, and grey bricks
    const tooltip = document.createElement('div');
    tooltip.className = 'tooltip';
    tooltip.textContent = actualIcon.dataset.tooltip;
    actualIcon.appendChild(tooltip);
    actualIcon.addEventListener('click', () => {
        actualIcon.classList.toggle('marked');
    }, { once: false });
    requestAnimationFrame(() => {
        const targetRect = actualIcon.getBoundingClientRect();
        requestAnimationFrame(() => {
            frontClone.style.left = targetRect.left + 'px';
            frontClone.style.top = targetRect.top + 'px';
            frontClone.style.width = targetRect.width + 'px';
            frontClone.style.height = targetRect.height + 'px';
            frontClone.style.opacity = '0';
        });
    });
    frontClone.addEventListener('transitionend', () => {
        document.body.removeChild(frontClone);
        actualIcon.style.visibility = 'visible';
        console.log(`animateCardToContainer: ${iconClass} made visible in ${containerId}`);
        if (callback) callback();
    }, { once: true });
}

function addNeitherIcon(text, opposite, category) {
    const icon = document.createElement('div');
    icon.className = 'neither-icon';
    icon.dataset.tooltip = text;
    icon.dataset.opposite = opposite;
    icon.dataset.category = category;
    icon.dataset.text = text;
    const tooltip = document.createElement('div');
    tooltip.className = 'tooltip';
    tooltip.textContent = text;
    icon.appendChild(tooltip);
    icon.addEventListener('click', () => {
        icon.classList.toggle('marked');
    });
    document.getElementById('neither-container').appendChild(icon);
    allSelections.push({ text, category, status: 'grey' });
}
function startUpdatePhase() {
    console.log('startUpdatePhase called');
    document.getElementById('game-container').style.display = 'block';
    document.getElementById('card-container').style.display = 'none';
    document.getElementById('undo-button').style.display = 'none';
    document.getElementById('reverse-button').style.display = 'none';
    document.getElementById('auto-progress').style.display = 'none';
    document.getElementById('results-container').style.display = 'none';
    updatePhase = 'red';
    instruction.innerText = 
    "You have completed the first phase of the game.\nYou likely had to choose some cards (both red and green) that you felt more strongly than others.The grey cards were what was left, probably most of these are in-between.\n\nThe next section lets you change some of those cards.\n\nWhen you click below, a 2 minute timer will appear.\n\nYou can now hover your mouse over any red card, you will see the statement you chose. You can click to strengthen that card (darker red) or to weaken it (grey).\n\nYou can click as many bricks as you like during the 2 minute period.\nPlease click on Continue when you are ready.";
    instruction.style.display = 'block';
    console.log('Setting continueButton.style.display to block, continueButton:', continueButton, 'current style:', continueButton ? continueButton.style.display : 'null');
    continueButton.style.display = 'block';
    continueButton.style.zIndex = '1200'; // Ensure it’s above other elements
    continueButton.style.position = 'relative'; // Reset to ensure visibility
    console.log('continueButton.style.display set to:', continueButton.style.display);
    // Force reflow
    continueButton.offsetHeight;
    requestAnimationFrame(() => {
        console.log('After reflow, continueButton.style.display:', continueButton.style.display);
        continueButton.focus();
        continueButton.addEventListener('click', () => {
            console.log('Continue button clicked, starting update phase, progressContainer.children.length:', progressContainer.children.length);
            startUpdatePhase();
            continueButton.style.display = 'none';
        }, { once: true });
        console.log('Event listener attached to continueButton, continueButton:', continueButton);
    });
    setTimeout(() => {
        console.log('Continue button display after delay:', continueButton.style.display);
        instruction.offsetHeight;
        continueButton.offsetHeight;
    }, 300);
}

function updateBricks(containerId, currentStatus) {
    console.log(`updateBricks called for ${containerId} with status ${currentStatus}`);
    const container = document.getElementById(containerId);
    const brickClasses = ['rejected-icon', 'selected-icon', 'neither-icon'];
    const bricks = container.querySelectorAll(brickClasses.map(cls => `.${cls}`).join(','));
    console.log(`Found ${bricks.length} bricks in ${containerId} with classes ${brickClasses.join(', ')}`);
    console.log('allSelections before update:', JSON.stringify(allSelections));
    if (bricks.length === 0) {
        console.log(`No bricks found in ${containerId}. Checking container contents:`, container.innerHTML);
    }
    let lastClickTime = 0;
    const debounceDelay = 200;
    bricks.forEach((brick, index) => {
        brick.classList.add('clickable');
        const handler = () => {
            const now = Date.now();
            if (now - lastClickTime < debounceDelay) {
                console.log(`Click on brick ${index} ignored: too soon after last click`);
                return;
            }
            lastClickTime = now;
            const text = brick.dataset.text;
            const opposite = brick.dataset.opposite;
            const category = brick.dataset.category;
            const currentBrickStatus = brick.classList.contains('rejected-icon') ? 'red' :
                                      brick.classList.contains('selected-icon') ? 'green' : 'grey';
            console.log(`Brick ${index} clicked: text=${text}, currentBrickStatus=${currentBrickStatus}, category=${category}`);
            const selection = allSelections.find(sel => sel.text === text && sel.status === currentBrickStatus);
            if (selection) {
                let newStatus;
                let newClass;
                if (currentBrickStatus === 'red') {
                    newStatus = 'grey';
                    newClass = 'neither-icon';
                    redSelections[category] = (redSelections[category] || 0) - 1;
                    brick.dataset.tooltip = text;
                } else if (currentBrickStatus === 'grey') {
                    newStatus = 'green';
                    newClass = 'selected-icon';
                    greenSelections[category] = (greenSelections[category] || 0) + 1;
                    brick.dataset.tooltip = text;
                } else if (currentBrickStatus === 'green') {
                    newStatus = 'red';
                    newClass = 'rejected-icon';
                    greenSelections[category] = (greenSelections[category] || 0) - 1;
                    redSelections[category] = (redSelections[category] || 0) + 1;
                    brick.dataset.tooltip = opposite;
                }
                console.log(`Updating selection: ${text} from ${selection.status} to ${newStatus}`);
                selection.status = newStatus;
                brick.className = `${newClass} clickable`;
                brick.classList.remove('marked'); // Remove dot on click
                // Update tooltip
                const oldTooltip = brick.querySelector('.tooltip');
                if (oldTooltip) brick.removeChild(oldTooltip);
                const newTooltip = document.createElement('div');
                newTooltip.className = 'tooltip';
                newTooltip.textContent = brick.dataset.tooltip;
                brick.appendChild(newTooltip);
                console.log(`Brick ${index} updated in place to ${newClass}, text=${text}`);
                console.log('allSelections after update:', JSON.stringify(allSelections));
            } else {
                console.log(`No matching selection found for text=${text}, status=${currentBrickStatus}`);
                console.log('allSelections:', JSON.stringify(allSelections));
            }
        };
        brick.removeEventListener('click', brick.onclick);
        brick.addEventListener('click', handler);
    });
}
        function endUpdatePhase(currentPhase) {
            console.log('endUpdatePhase called with phase:', currentPhase);
            clearInterval(timerInterval);
            timerInterval = null;
            timerCanvas.classList.add('hidden');
            const bricks = document.querySelectorAll('.clickable');
            bricks.forEach(brick => {
                brick.classList.remove('clickable');
            });
            let nextPhase;
            let nextInstruction;
            if (currentPhase === 'red') {
                nextPhase = 'green';
                nextInstruction = "Thank you for updating your red bricks.\nNow please update your green bricks in the same way.\n\nEach green brick represents a card you have chosen that resonates with you. If you want to change your choice, click to change to red -- or grey if not sure.\n\nPlease click on Continue when you are ready.";
            } else if (currentPhase === 'green') {
                nextPhase = 'grey';
                nextInstruction = "Now you will have 2 minutes to update your grey bricks.  These represent the cards that you neither rejected or selected.\n\nClick on any grey brick to change it to green, and again to change it to red.\n\nPlease click on Continue when you are ready.";
            } else {
                document.getElementById('game-container').style.display = 'none';
                displayResults();
                return;
            }
            updatePhase = nextPhase;
            instruction.innerText = nextInstruction;
            instruction.style.display = 'block';
            continueButton.style.display = 'block';
            continueButton.focus();
            console.log('Continue button display in endUpdatePhase:', continueButton.style.display);
            const nextContainer = currentPhase === 'red' ? 'selected-container' : 'neither-container';
            console.log(`Calling updateBricks for ${nextContainer} with status ${nextPhase}`);
            updateBricks(nextContainer, nextPhase);
        }
function timerClickHandler(timeLeft, timeLimit, drawTimer) {
    timeLeft.value += 60;
    timeLimit.value += 60;
    drawTimer(timeLeft.value, timeLimit.value);
}
continueButton.addEventListener('click', () => {
    if (!updatePhase) return;
    if (timerInterval) clearInterval(timerInterval);
    console.log('Continue button clicked, initiating timer for updatePhase:', updatePhase);
    continueButton.style.display = 'none';
    timerCanvas.classList.remove('hidden');
    timerCanvas.style.display = 'block';
    document.getElementById('timer-label').style.display = 'block';
    document.getElementById('instruction').style.display = 'block';
    let timeLimit = { value: 120 };
    let timeLeft = { value: timeLimit.value };
    drawTimer(timeLeft.value, timeLimit.value);
    timerInterval = setInterval(() => {
        console.log('Timer tick, timeLeft:', timeLeft.value, 'updatePhase:', updatePhase);
        timeLeft.value--;
        if (timeLeft.value >= 0) {
            drawTimer(timeLeft.value, timeLimit.value);
        } else {
            console.log('Timer expired, clearing interval, calling endUpdatePhase with updatePhase:', updatePhase);
            clearInterval(timerInterval);
            timerInterval = null;
            timerCanvas.removeEventListener('click', currentHandler);
            document.getElementById('timer-label').style.display = 'none';
            document.getElementById('instruction').style.display = 'none';
            endUpdatePhase(updatePhase);
        }
    }, 1000);
    const currentHandler = () => timerClickHandler(timeLeft, timeLimit, drawTimer);
    timerCanvas.removeEventListener('click', currentHandler);
    timerCanvas.addEventListener('click', currentHandler);
    if (updatePhase === 'red') {
        console.log('Initializing updateBricks for rejected-container with red phase');
        updateBricks('rejected-container', 'red');
    } else if (updatePhase === 'green') {
        console.log('Initializing updateBricks for selected-container with green phase');
        updateBricks('selected-container', 'green');
    } else if (updatePhase === 'grey') {
        console.log('Initializing updateBricks for neither-container with grey phase');
        updateBricks('neither-container', 'grey');
    }
});

    function bigIntToBase(n, base, digits) {
    if (n === 0n) return digits[0].repeat(63);
    let result = [];
    let temp = n;
    for (let i = 0; i < 63; i++) {
        const digit = Number(temp % base);
        console.log(`Digit ${i}: ${digit}, Char: ${digits[digit]}`);
        result.push(digits[digit]);
        temp = temp / base;
    }
    return result.reverse().join('');
}

function displayResults() {
    const resultsContainer = document.getElementById('results-container');
    resultsContainer.style.display = 'flex';
    resultsContainer.innerHTML = '<h2>Results</h2><pre></pre>';
    const copyButton = document.getElementById('copy-button');
    copyButton.style.display = 'block';
    const groupColors = {
        DAR: '#0000FF',
        ERS: '#FF00FF',
        IAP: '#800080',
        IL: '#FF0000'
    };
    const base58Digits = '23456789ABCDEFGHIJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz';
    const maxDescriptorLength = Math.max(...categoryData.map(({descriptor}) => descriptor.length));
    const sortedByGroup = categoryData.reduce((acc, {group, category, descriptor, total}) => {
        const greenCount = allSelections.filter(sel => sel.category === category && sel.status === 'green').length;
        const percentage = Math.round((greenCount / total) * 100);
        if (!acc[group]) acc[group] = [];
        acc[group].push({category, descriptor, percentage, total});
        return acc;
    }, {DAR: [], ERS: [], IAP: [], IL: []});
    const barChart = ['DAR', 'ERS', 'IAP', 'IL'].flatMap(group => {
        const categories = sortedByGroup[group].sort((a, b) => b.percentage - a.percentage);
        return categories.map(({descriptor, percentage}) => {
            const stars = '*'.repeat(Math.round(percentage / 10));
            const paddedDescriptor = descriptor.padEnd(maxDescriptorLength, ' ');
            return `${paddedDescriptor}: ${stars} (${percentage}%)`;
        });
    }).join('\n');
    const scores = questionsData.map((line, index) => {
        const [question, , category] = line.split('|');
        const trimmedQuestion = question.trim();
        const selection = allSelections.find(sel => sel.text.trim() === trimmedQuestion && sel.category === category);
        const score = selection ? (selection.status === 'red' ? 1 : selection.status === 'grey' ? 2 : 3) : 2;
        console.log(`Encode Question ${index + 1}: "${trimmedQuestion}", Category: ${category}, Selection:`, selection, `Score: ${score}`);
        return score;
    });
    console.log('Encoded scores:', scores);
    let number = BigInt(0);
    for (let i = 0; i < scores.length; i++) {
        number = number * BigInt(3) + BigInt(scores[i] - 1);
    }
    console.log('Input number to bigIntToBase:', number);
    const encoded = bigIntToBase(number, BigInt(58), base58Digits);
    if (encoded.length !== 63) {
        console.error('Encoded string length invalid:', encoded.length);
        resultsContainer.querySelector('pre').innerHTML = 'Error: Invalid encoded string length';
        return;
    }
    for (let char of encoded) {
        if (base58Digits.indexOf(char) === -1) {
            console.error('Invalid character in encoded string:', char);
            resultsContainer.querySelector('pre').innerHTML = 'Error: Invalid character in encoded string';
            return;
        }
    }
    let sum = 0n;
    for (let char of encoded) {
        sum += BigInt(base58Digits.indexOf(char));
    }
    const checksum = Number(sum % BigInt(58));
    console.log('Encoded checksum:', checksum, 'Checksum character:', base58Digits[checksum]);
    const resultString = encoded + base58Digits[checksum];
    console.log('Encoded resultString:', resultString);
    if (resultString.length !== 64) {
        console.error('Final result string length invalid:', resultString.length);
        resultsContainer.querySelector('pre').innerHTML = 'Error: Invalid final result string length';
        return;
    }
    const words = [];
    for (let i = 0; i < 64; i += 8) {
        words.push(resultString.slice(i, i + 8));
    }
    if (words.length !== 8 || words.some(s => s.length !== 8)) {
        console.error('Formatting failed:', { words });
        resultsContainer.querySelector('pre').innerHTML = 'Error: Formatting failed';
        return;
    }
    const formattedResult = words.join(' ');
    const outputText = barChart + '\n\nResult Sequence:\n' + formattedResult;
    resultsContainer.querySelector('pre').innerHTML = outputText;
    copyButton.onclick = () => {
        navigator.clipboard.writeText(outputText).then(() => {
            alert('Results copied to clipboard!');
        }).catch(err => {
            console.error('Failed to copy results:', err);
            alert('Failed to copy results.');
        });
    };
}

function displaySet() {
    console.log('displaySet called, allSelections.length:', allSelections.length, 'remainingQuestionsByCategory:', remainingQuestionsByCategory, 'progressContainer.children.length:', progressContainer.children.length);
    // Line before the end-of-phase check
    console.log('Before end check, allSelections.length:', allSelections.length, 'remainingQuestionsByCategory:', remainingQuestionsByCategory, 'progressContainer.children.length:', progressContainer.children.length);
    // Check if all 232 questions are selected, no more sets are available, or all progress icons are used
    if (allSelections.length >= 232 || (remainingQuestionsByCategory && Object.values(remainingQuestionsByCategory).every(cat => cat.length === 0)) || progressContainer.children.length === 0) {
        console.log('After end check, condition met:', allSelections.length >= 232 || (remainingQuestionsByCategory && Object.values(remainingQuestionsByCategory).every(cat => cat.length === 0)) || progressContainer.children.length === 0, 'allSelections.length:', allSelections.length, 'remainingQuestionsByCategory empty:', Object.values(remainingQuestionsByCategory).every(cat => cat.length === 0), 'progressContainer.children.length:', progressContainer.children.length);
        console.log('End of card phase detected, preparing to transition, allSelections.length:', allSelections.length, 'progressContainer.children.length:', progressContainer.children.length);
        const availableQuestions = [];
        for (const category in remainingQuestionsByCategory) {
            availableQuestions.push(...remainingQuestionsByCategory[category].map(q => ({ text: q.question, opposite: q.opposite, category })));
        }
        if (availableQuestions.length > 0 && availableQuestions.length <= 4) {
            console.log('Handling remaining questions:', availableQuestions.length);
            availableQuestions.forEach(q => {
                allSelections.push({ text: q.text, category: q.category, status: 'grey' });
                remainingQuestionsByCategory[q.category] = remainingQuestionsByCategory[q.category].filter(r => r.question !== q.text);
                if (progressContainer.lastChild) {
                    progressContainer.removeChild(progressContainer.lastChild);
                }
            });
            console.log('Updated allSelections.length:', allSelections.length, 'progressContainer.children.length:', progressContainer.children.length);
        }
        instruction.innerText = "All sets completed! Click Continue to proceed to the next phase.";
        cards.forEach(card => {
            card.style.display = 'none';
        });
        document.getElementById('undo-button').style.display = 'none';
        document.getElementById('reverse-button').style.display = 'none';
        document.getElementById('auto-progress').style.display = 'none';
        document.getElementById('game-container').style.display = 'block';
        console.log('Initiating phase transition, calling startUpdatePhase directly');
        startUpdatePhase(); // Direct call to ensure phase transition
        console.log('startUpdatePhase called, continueButton setup to follow');
        // Optional manual continue button as fallback
        console.log('Setting continueButton.style.display to block, continueButton:', continueButton);
        continueButton.style.display = 'block';
        continueButton.style.zIndex = '1200';
        continueButton.style.position = 'relative';
        console.log('continueButton.style.display set to:', continueButton.style.display);
        continueButton.addEventListener('click', () => {
            console.log('Continue button clicked, starting update phase manually, progressContainer.children.length:', progressContainer.children.length);
            startUpdatePhase();
            continueButton.style.display = 'none';
        }, { once: true });
        console.log('Event listener attached to continueButton, continueButton:', continueButton);
        continueButton.focus();
        return;
    }
    const set = getNextSet();
    console.log('getNextSet returned set:', set, 'allSelections.length:', allSelections.length, 'progressContainer.children.length:', progressContainer.children.length);
    if (!set) {
        console.log('No more sets available, triggering end of card phase, allSelections.length:', allSelections.length, 'progressContainer.children.length:', progressContainer.children.length);
        instruction.innerText = "All sets completed! Click Continue to proceed to the next phase.";
        cards.forEach(card => {
            card.style.display = 'none';
        });
        document.getElementById('undo-button').style.display = 'none';
        document.getElementById('reverse-button').style.display = 'none';
        document.getElementById('auto-progress').style.display = 'none';
        document.getElementById('game-container').style.display = 'block';
        console.log('Initiating phase transition, calling startUpdatePhase directly');
        startUpdatePhase(); // Direct call to ensure phase transition
        console.log('startUpdatePhase called, continueButton setup to follow');
        // Optional manual continue button as fallback
        console.log('Setting continueButton.style.display to block, continueButton:', continueButton);
        continueButton.style.display = 'block';
        continueButton.style.zIndex = '1200';
        continueButton.style.position = 'relative';
        console.log('continueButton.style.display set to:', continueButton.style.display);
        continueButton.addEventListener('click', () => {
            console.log('Continue button clicked, starting update phase manually, progressContainer.children.length:', progressContainer.children.length);
            startUpdatePhase();
            continueButton.style.display = 'none';
        }, { once: true });
        console.log('Event listener attached to continueButton, continueButton:', continueButton);
        continueButton.focus();
        return;
    }
    if (removeFromTop) {
        for (let i = 0; i < set.length && progressContainer.firstChild; i++) {
            progressContainer.removeChild(progressContainer.firstChild);
        }
    } else {
        for (let i = 0; i < set.length && progressContainer.lastChild; i++) {
            progressContainer.removeChild(progressContainer.lastChild);
        }
    }
    removeFromTop = !removeFromTop;
    const numIcons = progressContainer.children.length;
    const numRows = Math.ceil(numIcons / 12);
    progressContainer.style.gridTemplateRows = `repeat(${numRows}, 22px)`;
    progressContainer.style.height = `calc((22px + 2px) * ${numRows} - 2px)`;
    cards.forEach((card, index) => {
        if (index < set.length) {
            card.querySelector('.front').innerText = set[index].text;
            card.querySelector('.front').style.backgroundColor = '#abcfab'; /* Light green */
            card.dataset.category = set[index].category;
            card.dataset.text = set[index].text;
            card.dataset.opposite = set[index].opposite;
            card.style.display = 'block';
            card.style.visibility = 'visible';
            card.style.transform = '';
            card.style.opacity = '1';
            card.classList.remove('flipped', 'slide-down', 'slide-up', 'selected');
            card.removeAttribute('title'); // Remove card tooltip
        } else {
            card.style.display = 'none';
        }
    });
    isFlipped = false;
    selectionCount = 0;
    selectedCards = [];
    isAnimating = false;
    instruction.innerText = " Click any card to begin\n\n\n\n";
    document.getElementById('card-container').classList.add('select-phase');
    document.getElementById('undo-button').style.display = 'none';
    document.getElementById('reverse-button').style.display = 'none';
    document.getElementById('reverse-button').style.backgroundColor = '#ff9999'; /* Light red, as cards start green */
    document.getElementById('auto-progress').style.display = 'block'; // Show auto-progress button
    continueButton.style.display = 'none';
}

function flipCards() {
    cards.forEach(card => {
        if (card.style.display !== 'none') {
            card.classList.add('flipped');
            card.querySelector('.front').innerText = card.dataset.opposite;
            card.querySelector('.front').style.backgroundColor = '#ff9999'; /* Light red */
            card.removeAttribute('title'); // Remove card tooltip
        }
    });
    isFlipped = true;
    selectionCount = 0;
    instruction.innerText = "                                                     choose the card MOST like you\n                                                     (if none then reverse sentiment)\n\n\n\n";
    document.getElementById('card-container').classList.remove('select-phase');
    document.getElementById('card-container').classList.add('reject-phase');
    document.getElementById('undo-button').style.display = 'block';
    document.getElementById('reverse-button').style.display = 'block';
    document.getElementById('reverse-button').style.backgroundColor = '#abcfab'; /* Light green */
}
        document.getElementById('continue-button').addEventListener('click', startGame, { once: true });

function startGame() {
    instruction.innerText =
    `The first part of this session resembles a card game\n
    To your left are many blue boxes, each box represents a card.
    The system draws 5 cards from there, each card has a statement.\n
    Red cards show statements which are generally issues for you.
    Green cards show the opposite positive statement.
    Use the button "reverse sentiment" to look at your options.\n
    Click on a card when it is most correct for you.
    The 5th card in any set goes "grey" automatically (unsure)\n
    If a statement really fits you, once selected click again to mark
    it with a black dot.  This indicates a strong resonance\n
    When you are ready to start click continue\n\n\n\n\n\n`;
    continueButton.style.display = 'block';
    continueButton.focus();
    continueButton.addEventListener('click', () => {
        continueButton.style.display = 'none';
        instruction.innerText = "Click continue to begin the game";
        continueButton.style.display = 'block';
        continueButton.focus();
        continueButton.addEventListener('click', () => {
            continueButton.style.display = 'none'; // Ensure button hides after second click
            instruction.style.zIndex = -1; // Move instruction behind game elements
            // Create and display blue bricks
            for (let i = 0; i < 232; i++) {
                const icon = document.createElement('div');
                icon.className = 'progress-icon';
                icon.title = allQuestions[i].text;
                icon.dataset.category = allQuestions[i].category;
                progressContainer.appendChild(icon);
                const existingTooltip = icon.querySelector('.tooltip');
                if (existingTooltip) icon.removeChild(existingTooltip);
            }
            document.getElementById('card-container').style.display = 'flex'; // Use inline style to ensure display
            document.getElementById('progress-container').style.display = 'grid';
            document.getElementById('selected-container').style.display = 'flex';
            document.getElementById('rejected-container').style.display = 'flex';
            document.getElementById('neither-container').style.display = 'flex';
            // Dynamically create cards and attach event listeners
            const cardContainer = document.getElementById('card-container');
            for (let i = 0; i < 5; i++) {
                const cardWrapper = document.createElement('div');
                cardWrapper.className = 'card-wrapper';
                const card = document.createElement('div');
                card.className = 'card';
                const back = document.createElement('div');
                back.className = 'back';
                back.style.background = 'repeating-linear-gradient(60deg, #1e90ff, #1e90ff 13px, #24588c 10px, #104e8b 20px)';
                const front = document.createElement('div');
                front.className = 'front';
                card.appendChild(back);
                card.appendChild(front);
                cardWrapper.appendChild(card);
                cardContainer.appendChild(cardWrapper);
                cards.push(card);
                // Attach click event listener to each new card
                card.addEventListener('click', () => {
                    if (card.style.display === 'none' || isAnimating) return;
                    if (!isFlipped) {
                        flipCards();
                    } else if (selectionCount < 4) {
                        isAnimating = true;
                        const isRejectPhase = document.getElementById('card-container').classList.contains('reject-phase');
                        const status = isRejectPhase ? 'red' : 'green';
                        const containerId = isRejectPhase ? 'rejected-container' : 'selected-container';
                        const iconClass = isRejectPhase ? 'rejected-icon' : 'selected-icon';
                        const text = card.dataset.text;
                        const opposite = card.dataset.opposite;
                        const category = card.dataset.category;
                        if (status === 'red') {
                            redSelections[category] = (redSelections[category] || 0) + 1;
                        } else {
                            greenSelections[category] = (greenSelections[category] || 0) + 1;
                        }
                        selectedCards.push({ card, status });
                        card.style.visibility = 'hidden';
                        animateCardToContainer(card, containerId, iconClass, text, opposite, category, () => {
                            selectionCount++;  
                            allSelections.push({ text, category, status });
                            if (selectionCount === 4 || (selectionCount < 4 && progressContainer.children.length === 0)) {
                                const remainingCard = Array.from(cards).find(c => c.style.display !== 'none' && c.style.visibility !== 'hidden');
                                if (remainingCard) {
                                    const neitherText = remainingCard.dataset.text;
                                    const neitherOpposite = remainingCard.dataset.opposite;
                                    const neitherCategory = remainingCard.dataset.category;
                                    animateCardToContainer(remainingCard, 'neither-container', 'neither-icon', neitherText, neitherOpposite, neitherCategory, () => {
                                        currentSetIndex++;
                                        displaySet();
                                    });
                                    remainingCard.style.visibility = 'hidden';
                                    allSelections.push({ text: neitherText, category: neitherCategory, status: 'grey' });
                                } else {
                                    currentSetIndex++;
                                    displaySet();
                                }
                            } else {
                                instruction.innerText = isRejectPhase ? "                                                     choose the card MOST like you\n                                                     (if none then reverse sentiment)\n\n\n\n" : "                                                     choose the card MOST like you\n                                                     (if none then reverse sentiment)\n\n\n\n";
                                document.getElementById('undo-button').style.display = 'block';
                                document.getElementById('reverse-button').style.display = (5 - selectionCount) >= 2 ? 'block' : 'none';
                                document.getElementById('reverse-button').style.backgroundColor = isRejectPhase ? '#abcfab' : '#ff9999'; /* Opposite of current card color */
                                isAnimating = false;
                            }
                        });
                    }
                });
            }
            displaySet();
        }, { once: true });
    }, { once: true });
}
       instruction.innerText =
    `You are about to go through an interactive experience that will ask you some questions you may find very sensitive.\n
    This session is totally anonymous, 
    your name is not recorded and no-one can see what you enter.\n
    At the end of the session you will get a results summary.
    This should give you insight into some of your deeper motivations and potential blockers to your learning.\n
    This can be very useful for your coach. It is up to you to forward your results at the end. If you take no action, all data is deleted\n
    To forward your results, just copy and paste your results summary at the end into an email and send it.\n
    The full session will take 20 to 30 minutes
    When you are ready to progress click continue\n\n\n\n\n\n\n\n`;
continueButton.style.display = 'block';
continueButton.focus();

function undoRejection() {
    if (selectedCards.length > 0 && selectionCount > 0) {
        const lastCard = selectedCards.pop();
        selectionCount--;
        const containerId = lastCard.status === 'red' ? 'rejected-container' : 'selected-container';
        const container = document.getElementById(containerId);
        if (container.lastChild) {
            const text = container.lastChild.dataset.text;
            const selection = allSelections.find(sel => sel.text === text && sel.status === lastCard.status);
            if (selection) {
                if (lastCard.status === 'red') {
                    redSelections[selection.category]--;
                } else {
                    greenSelections[selection.category]--;
                }
                allSelections.splice(allSelections.indexOf(selection), 1);
            }
            container.removeChild(container.lastChild);
        }
        lastCard.card.style.visibility = 'visible';
        const cardContainer = document.getElementById('card-container');
        const isRejectPhase = cardContainer.classList.contains('reject-phase');
        lastCard.card.querySelector('.front').innerText = isRejectPhase ? lastCard.card.dataset.opposite : lastCard.card.dataset.text;
        lastCard.card.title = isRejectPhase ? lastCard.card.dataset.text : lastCard.card.dataset.opposite;
        lastCard.card.querySelector('.front').style.backgroundColor = isRejectPhase ? '#ff9999' : '#abcfab';
        instruction.innerText = "                                                     choose the card MOST like you\n                                                     (if none then reverse sentiment)\n\n\n\n";
        document.getElementById('undo-button').style.display = 'block';
        document.getElementById('reverse-button').style.display = (5 - selectionCount) >= 2 ? 'block' : 'none';
    }
}

function reverseSentiment() {
    if (isAnimating || selectionCount >= 4 || (5 - selectionCount) < 2) return;
    const cardContainer = document.getElementById('card-container');
    const isRejectPhase = cardContainer.classList.contains('reject-phase');
    cardContainer.classList.toggle('reject-phase');
    cardContainer.classList.toggle('select-phase');
    const remainingCards = Array.from(cards).filter(c => c.style.display !== 'none' && c.style.visibility !== 'hidden');
    remainingCards.forEach(card => {
        card.querySelector('.front').innerText = isRejectPhase ? card.dataset.text : card.dataset.opposite;
        card.title = isRejectPhase ? card.dataset.opposite : card.dataset.text;
        card.querySelector('.front').style.backgroundColor = isRejectPhase ? '#abcfab' : '#ff9999'; /* Light green, Light red */
    });
    document.getElementById('reverse-button').style.backgroundColor = isRejectPhase ? '#ff9999' : '#abcfab'; /* Opposite of new card color */
}

cards.forEach((card, index) => {
    card.addEventListener('click', () => {
        if (card.style.display === 'none' || isAnimating) return;
        if (!isFlipped) {
            flipCards();
        } else if (selectionCount < 4) {
            isAnimating = true;
            const isRejectPhase = document.getElementById('card-container').classList.contains('reject-phase');
            const status = isRejectPhase ? 'red' : 'green';
            const containerId = isRejectPhase ? 'rejected-container' : 'selected-container';
            const iconClass = isRejectPhase ? 'rejected-icon' : 'selected-icon';
            const text = card.dataset.text;
            const opposite = card.dataset.opposite;
            const category = card.dataset.category;
            if (status === 'red') {
                redSelections[category] = (redSelections[category] || 0) + 1;
            } else {
                greenSelections[category] = (greenSelections[category] || 0) + 1;
            }
            selectedCards.push({ card, status });
            animateCardToContainer(card, containerId, iconClass, text, opposite, category, () => {
                selectionCount++;
                card.style.visibility = 'hidden';
                allSelections.push({ text, category, status });
                if (selectionCount === 4 || (selectionCount < 4 && progressContainer.children.length === 0)){
                    const remainingCard = Array.from(cards).find(c => c.style.display !== 'none' && c.style.visibility !== 'hidden');
                    if (remainingCard) {
                        const neitherText = remainingCard.dataset.text;
                        const neitherOpposite = remainingCard.dataset.opposite;
                        const neitherCategory = remainingCard.dataset.category;
                        animateCardToContainer(remainingCard, 'neither-container', 'neither-icon', neitherText, neitherOpposite, neitherCategory, () => {
                            currentSetIndex++;
                            displaySet();
                        });
                        remainingCard.style.visibility = 'hidden';
                        allSelections.push({ text: neitherText, category: neitherCategory, status: 'grey' });
                    } else {
                        currentSetIndex++;
                        displaySet();
                    }
                } else {
                    instruction.innerText = "                                                     choose the card MOST like you\n                                                     (if none then reverse sentiment)\n\n\n\n";
                    document.getElementById('undo-button').style.display = 'block';
                    document.getElementById('reverse-button').style.display = (5 - selectionCount) >= 2 ? 'block' : 'none';
                    document.getElementById('reverse-button').style.backgroundColor = isRejectPhase ? '#abcfab' : '#ff9999'; /* Opposite of current card color */
                    isAnimating = false;
                }
            });
        }
    });
});

document.getElementById('reverse-button').addEventListener('click', reverseSentiment);
document.getElementById('undo-button').addEventListener('click', undoRejection);

const autoProgressButton = document.getElementById('auto-progress');
autoProgressButton.addEventListener('click', () => {
    autoProgressButton.disabled = true;
    const interval = setInterval(() => {
        const instructionText = instruction.innerText.trim();
        if (progressContainer.children.length <= 8) {
            console.log('Auto Progress stopped: 8 or fewer blue boxes remaining');
            clearInterval(interval);
            return;
        }
        if (instructionText === "Click any card to begin") {
            const visibleCards = Array.from(cards).filter(c => c.style.display !== 'none');
            if (visibleCards.length > 0) visibleCards[0].click(); // Flip the first card to start
        } else if (instructionText !== "Click any card to begin") {
            const visibleCards = Array.from(cards).filter(c => c.style.display !== 'none' && c.style.visibility !== 'hidden');
            if (visibleCards.length > 0) {
                visibleCards[0].click(); // Select first card
                setTimeout(() => {
                    if (selectionCount < 4 && visibleCards.length > 1) visibleCards[1].click(); // Select second card
                    setTimeout(() => {
                        if (selectionCount < 4 && visibleCards.length > 2) visibleCards[2].click(); // Select third card
                        setTimeout(() => {
                            if (selectionCount < 4 && visibleCards.length > 3) visibleCards[3].click(); // Select fourth card
                        }, 300);
                    }, 300);
                }, 300);
            }
        } else if (instructionText.includes("When you are ready to start click continue")) {
            continueButton.click();
        } else if (instructionText === "Click continue to begin the game") {
            continueButton.click();
        } else if (instructionText.includes("Please click on Continue")) {
            console.log('Auto Progress: Clicking Continue button');
            continueButton.click();
        } else if (instructionText === "All sets completed! Click Continue to proceed to the next phase.") {
            clearInterval(interval);
        }
    }, 300);
});
    </script>
</body>
</html>
