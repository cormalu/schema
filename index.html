<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Card Game</title>
    <style>
        body {
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            overflow: hidden;
        }
        #game-container {
            position: relative;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        :root {
            --selected-bg: #FFA500; /* Orange for selected/resonant */
            --darkened-selected-bg: #C97814; /* Dark orange for strengthened selected */
            --selected-border: #C97814; /* Dark orange border */
            --rejected-bg: #90EE90; /* Light green for rejected/non-resonant */
            --darkened-rejected-bg: #006400; /* Dark green for strengthened rejected */
            --rejected-border: #006400; /* Dark green border */
        }
#strengthen-instruction {
    position: absolute;
    top: calc(50% + 150px); /* Adjusted to be below dropped cards (240px height / 2 + drop 20px + margin) */
    left: 50%;
    transform: translateX(-50%);
    font-size: 14px;
    color: #333;
    text-align: center;
    white-space: nowrap;
    display: none;
    z-index: 1000;
}
#instruction {
    font-size: 18px;
    font-weight: bold;
    max-width: 600px;
    text-align: center;
    white-space: pre-wrap;
    background-color: transparent;
    padding: 0;
    position: absolute;
    top: -15%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 1000;
}
#card-container {
    display: flex;
    justify-content: center;
    gap: 15px;
    position: relative;
    left: 140px; /* Shift 1.5 card widths (240px) to the right toward grey bricks */
}
.selected-card {
    transform: translateY(20px) scale(0.9);
    transition: transform 0.3s ease-in-out;
    font-size: 14.4px; /* 90% of original 16px */
    border: 3px solid;
    box-sizing: border-box;
}
.selected-card.selected {
    border-color: var(--selected-border);
}
.selected-card.rejected {
    border-color: var(--rejected-border);
}
.selected-card.darkened .front {
    font-weight: bold;
}
#card-container .selected-card.selected .front {
    background-color: var(--selected-bg) !important;
}
#card-container .selected-card.rejected .front {
    background-color: var(--rejected-bg) !important;
}
.card-wrapper {
    width: 160px; /* Smaller width */
    height: 240px; /* Smaller height */
    position: relative;
}
.front {
    background: white;
    transform: rotateY(180deg);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px; /* Adjusted font size for smaller cards */
    text-align: center;
    padding: 15px;
    box-sizing: border-box;
}
        .card {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            perspective: 1000px;
            cursor: pointer;
        }
        .back, .front {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            transition: transform 0.5s ease-in-out;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .back {
background: repeating-linear-gradient(
        60deg,
        #1e90ff, /* Light blue base */
        #1e90ff 13px,
        #24588c 10px, /* Darker blue for pattern */
        #104e8b 20px
    ); /* Playing card texture: diagonal stripes */
            transform: rotateY(0deg);
        }
        .front {
            background: white;
            transform: rotateY(180deg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
        }
#card-container.rejected-phase .front {
    background-color: var(--rejected-bg);
}
#card-container.selected-phase .front {
    background-color: var(--selected-bg);
        }
        .flipped .back {
            transform: rotateY(180deg);
        }
        .flipped .front {
            transform: rotateY(0deg);
        }
        .slide-down {
            transform: translateY(100vh);
            opacity: 0;
            transition: transform 0.5s ease-in-out, opacity 0.5s ease-in-out;
        }
        .slide-up {
            transform: translateY(-100vh);
            opacity: 0;
            transition: transform 0.5s ease-in-out, opacity 0.5s ease-in-out;
        }
        .selected {
            border: 4px solid green;
        }
#progress-container {
    position: absolute;
    left: 10px;
    top: 50%;
    transform: translateY(-50%);
    display: none; /* Hidden initially */
    grid-template-columns: repeat(10, 40px); /* 10 columns wide */
    gap: 10px; /* Increased spacing between rows and columns */
    width: 488px; /* Adjusted for 10 columns of 40px + gaps */
    background-color: transparent;
}
#selected-container {
    position: absolute;
    top: calc(50% - 277px);
    left: 10px;
    width: 550px;
    max-height: 96px;
    display: none; /* Hidden initially */
    flex-direction: row;
    flex-wrap: wrap;
    justify-content: flex-start;
    align-content: flex-start;
    gap: 4px;
}
#rejected-container {
    position: absolute;
    left: 10px;
    top: calc(50% + 247px);
    width: 950px;
    max-height: 96px;
    display: none; /* Hidden initially */
    flex-direction: row;
    flex-wrap: wrap;
    justify-content: flex-start;
    align-content: flex-start;
    gap: 4px;
    z-index: 500;
}
#neither-container {
    position: absolute;
    right: 10px;
    top: calc(50% - 277px);
    width: 220px;
    height: auto;
    display: none; /* Hidden initially */
    flex-direction: row-reverse;
    flex-wrap: wrap;
    justify-content: flex-start;
    align-content: flex-start;
    gap: 4px;
    overflow: visible;
}
.progress-icon {
    width: 40px; /* Narrower width for vertical orientation */
    height: 70px; /* Taller height for vertical card-like stack */
    background: repeating-linear-gradient(
        60deg,
        #1e90ff,
        #1e90ff 6.5px, /* Finer stripes */
        #24588c 5px,
        #104e8b 10px
    );
    background-size: 10px 10px; /* Finer pattern repeat */
    border-radius: 4px;
    position: relative;
    cursor: pointer;
    box-shadow: 4px 4px 0 rgba(0, 0, 0, 0.1); /* Simulates slight overlap/shadow for stack effect */
}
.progress-icon::before {
    content: '';
    position: absolute;
    top: -4px;
    left: -4px;
    width: 100%;
    height: 100%;
    background: inherit;
    background-size: inherit;
    border-radius: 4px;
    opacity: 0.5; /* Semi-transparent to show as overlapping card */
    z-index: -1; /* Behind main icon for stack look */
}
.progress-icon:hover::after {
    content: "Hand of cards";
    position: absolute;
    background-color: #333;
    color: white;
    padding: 5px;
    border-radius: 5px;
    top: -40px; /* Adjusted for taller icon */
    left: 0;
    white-space: nowrap;
    z-index: 1000;
}
.selected-icon {
    width: 40px;
    height: 20px;
    background-color: var(--selected-bg); /* Orange for selected brick */
    border-radius: 4px;
    margin: 2px;
    box-sizing: border-box;
    position: relative; /* Ensure dot positions relative to brick */
}
.selected-icon.darkened {
    background-color: var(--darkened-selected-bg); /* Dark orange for strengthened selected */
}
.rejected-icon {
    width: 40px;
    height: 20px;
    background-color: var(--rejected-bg); /* Light green for rejected brick */
    margin: 2px;
    border-radius: 4px;
    box-sizing: border-box;
    position: relative; /* Ensure dot positions relative to brick */
}
.rejected-icon.darkened {
    background-color: var(--darkened-rejected-bg); /* Dark green for strengthened rejected */
}
        .neither-icon {
            width: 40px;
            height: 20px;
            background-color: #D3D3D3;
            margin: 2px;
            border-radius: 4px;
            box-sizing: border-box;
            background-image: linear-gradient(45deg, rgba(0,0,0,0.1) 25%, transparent 25%, transparent 50%, rgba(0,0,0,0.1) 50%, rgba(0,0,0,0.1) 75%, transparent 75%, transparent);
            background-size: 4px 4px;
            position: relative; /* Ensure dot positions relative to brick */
        }
        .hidden {
            display: none;
        }
        .temp-icon {
            position: fixed;
            z-index: 1000;
            transition: left 0.5s ease-in-out, top 0.5s ease-in-out, width 0.5s ease-in-out, height 0.5s ease-in-out, opacity 0.5s ease-in-out;
            pointer-events: none;
            display: block;
        }
#undo-button {
    position: absolute;
    top: -20%;
    left: calc(50% - 150px);
    padding: 10px 20px;
    border-radius: 20px;
    font-size: 16px;
    font-weight: bold;
    background-color: #ddd;
    border: none;
    cursor: pointer;
    display: none;
}
        #auto-progress {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            bottom: -100px;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            background-color: #ddd;
            border: none;
            cursor: pointer;
        }
        #results-container {
            display: none;
            font-size: 16px;
            font-family: monospace;
            justify-content: left;
            align-items: center;
            min-height: 100vh;
            width: 100%;
            text-align: left;
        }
        #timer-canvas {
            margin: 10px;
            position: absolute;
            top: calc(50% - 230px); /* Higher to be above instruction */
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            display: block;
            cursor: pointer; /* Indicate clickability */
        }
        #timer-label {
            font-size: 14px;
            color: #000;
            position: absolute;
            top: calc(50% - 260px); /* Above timer */
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            display: none; /* Hidden by default */
        }
        #continue-button {
            padding: 10px 20px;
            font-size: 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 5px;
            position: absolute;
            top: calc(50% + 120px);
            left: 50%;
            transform: translateX(-50%);
            z-index: 1200;
            display: none;
        }
        .clickable {
            cursor: pointer;
            position: relative;
        }
.rejected-icon.darkened {
    background-color: var(--darkened-rejected-bg); /* Dark green for strengthened rejected */
}
.selected-icon.darkened {
    background-color: var(--darkened-selected-bg); /* Dark orange for strengthened selected */
}
.tooltip {
    position: absolute;
    background-color: #fff;
    color: #000;
    border: 1px solid #000;
    padding: 5px;
    border-radius: 5px;
    top: -30px; /* Aligned with blue brick tooltip */
    z-index: 2000;
    opacity: 0;
    transition: opacity 0.2s ease-in 0.2s;
    pointer-events: none;
    white-space: nowrap;
}
.rejected-icon.darkened .tooltip, .selected-icon.darkened .tooltip {
    font-weight: bold;
}
.rejected-icon:hover .tooltip,
.selected-icon:hover .tooltip {
    left: 0; /* Left-justified for red and green bricks */
    text-align: left;
    opacity: 1;
}
#neither-container .tooltip {
    right: 0 !important;
    text-align: right !important;
    left: auto !important;
    color: #808080 !important;
}
#neither-container :hover .tooltip {
    opacity: 1;
}
#selected-container .neither-icon .tooltip,
#rejected-container .neither-icon .tooltip,
#neither-container .neither-icon .tooltip {
    color: #808080 !important; /* Mid-grey for grey brick tooltips */
}
    </style>
</head>
<body>
    <div id="game-container">
        <div id="progress-container"></div>
        <div id="selected-container"></div>
        <div id="instruction"></div>
<div id="card-container" class="hidden" style="display: none;">
    <div id="strengthen-instruction">If a statement is particularly true, click on any selected card to strengthen it</div>
    <!-- Cards will be dynamically created after the second "Continue" click -->
     </div>
<button id="undo-button">Undo last selection</button>
<button id="reverse-button" style="position: absolute; top: -20%; left: calc(50% + 50px); padding: 10px 20px; border-radius: 20px;
font-size: 16px; font-weight: bold; background-color: #FFA500; border: none; cursor: pointer;
display: none; z-index: 1000;">Reverse Sentiment</button>
<button id="auto-progress" style="position: absolute; left: 50%; transform: translateX(-50%); bottom: -100px; padding: 5px 15px; border-radius: 20px; font-size: 14px; background-color: #ddd; border: none; cursor: pointer;">Auto Progress</button>
        <button id="continue-button">Continue</button>
        <button id="copy-button" style="display: none; padding: 10px 20px; font-size: 16px; background-color: #4CAF50; color: white; border: none; cursor: pointer; border-radius: 5px; position: absolute; top: calc(50% + 180px); left: 50%; transform: translateX(-50%); z-index: 1200;">Click to Copy Results</button>
        <div id="rejected-container"></div>
        <div id="neither-container"></div>
    </div>
    <div id="results-container"></div>
    <script>
        // Hard-coded text and parameters
        const QUESTIONS_DATA = [
"People have not been there to help me handle my feelings. | People have always been there to help me handle my feelings.|ed",
"I have not gotten enough love and attention. | I have gotten enough love and attention.|ed",
"Mostly, I have not had someone to depend on for advice and help with how I feel. | Mostly, I have had someone to depend on for advice and help with how I feel.|ed",
"I have mostly not had someone to look after me, share themself with me, or care deeply about what happens to me. | I have mostly had someone to look after me, share themself with me, or care deeply about what happens to me.|ed",
"I have not or rarely had someone who wanted to get close to me and spend a lot of time with me. | I have usually had someone who wanted to get close to me and spend a lot of time with me.|ed",
"People have mostly not been there to give me warmth and kindness. | People have mostly been there to give me warmth and kindness.|ed",
"For much of my life, I have not felt that I am special to someone. | For much of my life, I have mostly felt that I am special to someone.|ed",
"I have usually not had someone who really listens to me or is tuned into my true needs and feelings. | I have usually had someone who really listens to me and is tuned into my true needs and feelings.|ed",
"I have rarely had a strong person to give me advice or direction when I need it. | I have usually had a strong person to give me advice or direction when I need it.|ed",
"I worry that the people I love will die soon, even though there is little medical reason for me to worry. | I don't tend to worry or think much about the fact that the people I love will die at some time.|ab",
"I find myself clinging to people I am close to, because I am afraid they will leave me. | I am pretty secure with the people I am close to, I never think about them leaving me.|ab",
"I worry that people I feel close to will leave me or abandon me. |I never worry that people I feel close to will leave me or abandon me.e|a",
"I feel that I lack a stable base of support from someone who cares about me. | I feel that I have a stable base of support from someone who cares about me.|ab",
"I do not feel that important relationships will last; I expect them to end. | I generally feel that important relationships will last.|ab",
"I feel addicted to partners who cannot be there for me in a committed way. | I tend to find partners who can be there for me in a committed way.|ab",
"In the end, I will be alone. | In the end, I will have people around me.|ab",
"When I feel someone I care for pulling away from me, I can do crazy things. | When I feel someone I care for pulling away from me, I can handle it fine.|ab",
"Sometimes I am so worried about people leaving me that I drive them away. | When I am worried about people leaving me, I can give them the space they need.|ab",
"I become upset when someone leaves me alone, even for a short period of time. | I am quite happy when someone leaves me alone, even for a longer periods of time.|ab",
"I cannot count on people who I should be able to rely on to be there when I need them. | I can count on people who I should be able to rely on to be there when I need them.|ab",
"I cannot let myself get really close to other people, because I cannot be sure they will always be there. | When I let myself get really close to other people, it is because I can usually judge that they will be there when I need them.|ab",
"It seems that the important people in my life are always coming and going. | It seems that the important people in my life are stable fixtures.|ab",
"I worry a lot that the people I love will find someone else they prefer and leave me. | I never think that the people I love might find someone else they prefer or leave me.|ab",
"People close to me have been unpredictable: one moment they are nice to me, the next they are angry, upset, selfish or fighting. | People close to me have been predictable: they have had stable tempraments, seldom angry, upset, selfish or fighting.|ab",
"I need other people so much that I worry about losing them. | I am pretty self-reliant.  I never worry about losing anyone.|ab",
"I cannot be myself or express what I really feel, or people will leave me. | I am happy expressing what I really feel and confident people close to me will accept me regardless.|ab",
"I feel that people will take advantage of me. | I do not think that people usually will try to take advantage of me.|ma",
"I often feel that I have to protect myself from other people. | I seldom feel that I have to protect myself from other people.|ma",
"I am reluctant to let my guard down in the presence of other people, or else they will plan to hurt me. | I am happy to be open about who I am in the presence of other people, people are generally kind and accepting.|ma",
"If someone acts nicely towards me, I assume that they must be after something. | If someone acts nicely towards me, I assume that they are just being kind.|ma",
"It is only a matter of time before someone betrays me. | If someone betrays me that would be very unusual, it seldom happens.|ma",
"Most people only think about themselves. | Most people think about others and want to help.|ma",
"I have a great deal of difficulty trusting people. | I tend in general to trust people.|ma",
"I am quite suspicious of other peoples motives. | I am seldom suspicious of other peoples motives.|ma",
"Other people are rarely honest; they are usually not what they appear. | People are generally honest; they are usually what they appear to be.|ma",
"I am usually on the lookout for peoples ulterior motives. | I don't usually think about other peoples ulterior motives.|ma",
"If I think someone is out to hurt me, I try to hurt him or her first. | If I think someone is out to hurt me, I try to make up with them or avoid them.|ma",
"People usually have to prove themselves to me before I can trust them. | People don't have to prove themselves to me.  I generally trust people until proven otherwise.|ma",
"I set up tests for other people, to see if they are telling me the truth and are well-intentioned. | I don't believe in setting up tests for other people, I trust that they are telling me the truth and are well-intentioned.|ma",
"I subscribe to the belief: Control or be controlled. | Co-operation is much more important than controlling people.  I believe in working with people.|ma",
"I get angry when I think about the ways I have been mistreated by other people during my life. | I feel forgiveness when I think about the ways I have been mistreated by other people during my life.|ma",
"During my life, those close to me have taken advantage of me or used me for their own purposes. | During my life, those close to me have supported me even when it didn't suit their own purposes.|ma",
"Important people in my life have often tried to hurt my feelings or physically, or sexually abused me. | Important people in my life have never tried to hurt my feelings or physically, or sexually abused me.|ma",
"I do not fit in. | I fit in.|si",
"I am fundamentally different from other people. | I am pretty similar to many other people.|si",
"I do not belong; I am a loner. | I know where I belong; I am happy in my group.|si",
"I feel alienated from other people. | I seldom feel alienated from other people.|si",
"I feel isolated and alone. | I almost never feel isolated and alone.|si",
"I always feel on the outside of groups. | I usually confident within the groups I am part of.|si",
"No one really understands me. | Some people I am close to really understand me.|si",
"My family was always different from the families around us. | My family was pretty similar to the families around us.|si",
"I sometimes feel as if I am an alien. | I never feel as if I am an alien.|si",
"If I disappeared tomorrow, no one would notice. | If I disappeared tomorrow a lot of people would be affected.|si",
"No one I desire could love me once they see my defects. | Even with all my defects, I am confident I am a lovable person.|ds",
"No one I desire would want to stay close to me if they knew the real me. | Despite my deepest secrets, I am confident that someone I desire would still want to be close to me.|ds",
"I am just born flawed and defective. | In general people are not born flawed and defective. I was not born that way.|ds",
"No matter how hard I try, I doubt I will be able to get a significant man or woman to respect me or feel that I am worthwhile. | I expect I will be able to get a significant man or woman to respect me or feel that I am worthwhile.|ds",
"I am unworthy of the love, attention, and respect of others. | I am worthy of the love, attention, and respect of others.|ds",
"I feel that I am not lovable. | I feel that I am lovable.|ds",
"I am unacceptable in very basic ways. I do not want others to see the real me. | I am acceptable in my essence. I want others to see the real me.|ds",
"If others found out about my basic defects, I could not face them. | If others found out about any of my defects that’s fine with me, its part of life.|ds",
"When people like me, I feel I am fooling them. | When people like me I can understand why.|ds",
"Often I find that I want to spend time with people who are very critical of me or reject me. | I tend not to spend time with people who are very critical of me or reject me.|ds",
"I have inner secrets that I do not want people close to me to find out. | I do not have inner secrets that I want to hide from people close to me.|ds",
"It is my fault that my parents could not love me enough. | If my parents ever treated me coldly or did not love me enough, that is their responsibility not mine.|ds",
"I do not let people know the real me. | I try to let people know the real me.|ds",
"One of my greatest fears is that my defects will be exposed. | I do not worry at all that my defects will be exposed.|ds",
"I cannot understand how anyone could love me. | I can understand how anyone could love me.|ds",
"Almost nothing I do at work is as good as other people can do. | Almost everything I do at work is as good as other people can do.|fa",
"I am incompetent when it comes to achievement. | I am pretty successful when it comes to achievement.|fa",
"Most other people are more capable than I am at work or in other things I do. | Most other people are not as capable as I am at work or in other things I do.|fa",
"I am a failure. | I am a success.|fa",
"I am not as talented in my work as most people are at theirs. | I am just as talented in my work as most people are at theirs.|fa",
"I am not as intelligent as most people when it comes to work. | I am just as intelligent as most people when it comes to work.|fa",
"I am humiliated by my failures and inadequacies at work. | I am unbothered by any failures or inadequacies at work.|fa",
"I often feel embarrassed around other people, because I do not measure up to them in terms of what I have done. | I seldom feel embarrassed around other people as a result of not measuring up to them in terms of what I have done.|fa",
"I often compare the things I have done with others and feel that they are more successful. | If I compare the things I have done with others, I usually feel that I am more successful.|fa",
"I do not feel capable of getting by on my own in everyday life. | I feel fully capable of getting by on my own in everyday life.|di",
"I need other people to help me get by. | I do not need other people to help me get by.|di",
"I do not feel I can cope well by myself. | I feel I can cope well by myself.|di",
"I believe that other people can take care of me better than I can take care of myself. | I believe that I can take care of myself better than other people can take care of me.|di",
"I have trouble tackling new tasks outside of work unless I have someone to guide me. | I have no problem tackling new tasks outside of work and seldom need anyone to guide me.|di",
"I think of myself as a dependent person when it comes to getting through the days and weeks. | I do not think of myself as a dependent person when it comes to getting through the days and weeks.|di",
"I screw up everything I try, even outside of work. | I usually succed in most things I try, even outside of work.|di",
"I am inept in most areas of life. | I am competent in most areas of life.|di",
"If I trust my own judgment in everyday situations I will make the wrong decision. | If I trust my own judgment in everyday situations I will make the right decision.|di",
"I lack common sense. | I have common sense.|di",
"My judgment cannot be relied on in everyday situations. | My judgment can be relied on in everyday situations.|di",
"I do not feel confident about my ability to solve everyday problems. | I feel confident about my ability to solve everyday problems.|di",
"I need someone I can rely on to give me advice about practical issues. | I seldom need someone to rely on to give me advice about practical issues.|di",
"I feel more like a child than an adult when it comes to handling the problems of everyday life. | I feel fully adult when it comes to handling the problems of everyday life.|di",
"I find the responsibilities of everyday life overwhelming. | I find the responsibilities of everyday life easy to handle.|di",
"I cannot seem to escape the feeling that something bad is about to happen. | I almost never have the feeling that something bad is about to happen.|vu",
"I feel that a disaster (criminal, financial, or medical) could strike at any moment. | I don't tend to think that a disaster (criminal, financial, or medical) could strike at any moment.|vu",
"I worry about becoming a street person or vagrant. | I never worry about becoming a street person or vagrant.|vu",
"I worry about being attacked. | I never worry about being attacked.|vu",
"I take great precautions to avoid getting sick or hurt. | I do not take any precautions to avoid getting sick or hurt.|vu",
"I worry that I am developing a serious illness even though nothing has been diagnosed. | I do not worry or even think about developing a serious illness.|vu",
"I am a fearful person. | I am not a fearful person.|vu",
"I worry a lot about the bad things happening in the world like crime or pollution. | I do not worry about the bad things happening in the world like crime or pollution.|vu",
"I feel that I might go crazy. | I never think that I might go crazy.|vu",
"I often feel that I am going to have an anxiety attack. | I never feel that I am going to have an anxiety attack.|vu",
"I worry that I might have a heart attack or cancer even though there is little medical reason to. | I never worry or think that I might have a heart attack or cancer until there is medical reason to.|vu",
"I feel the world is a dangerous place. | I feel the world is a safe place.|vu",
"I have not been able to separate myself from my parents the way other people my age seem to. | I have been able to separate myself from my parents, I make my own decisions.|eu",
"My parents and I tend to be overinvolved in each others lives and problems. | My parents and I have appropriate separation from each others lives and problems.|eu",
"It is very difficult for my parents and me to keep intimate details from each other, without feeling betrayed or guilty. | My parents and I are happy to keep our intimate details from each other, appropriate distance is healthy.|eu",
"My parents and I have to speak to each other almost every day, or else one of us feels guilty, disappointed, or alone. | I speak to my parents regularly but if there is a gap in communication that is fine on both sides.|eu",
"I often feel that I do not have a separate identity from my parents or partner. | I have a separate identity from my parents and partner.|eu",
"I often feel as if my parents are living through me — I do not have a life of my own. | My parents are living their lives — I am living my own, separate life.|eu",
"It is very difficult for me to maintain any distance from the people I am really close to; I have trouble keeping any separate sense of myself. | It is normal for me to maintain some distance from the people I am really close to; I have no trouble keeping a separate sense of myself.|eu",
"I am so involved with my partner or parents that I do not really know who I am or what I want. |  I know who I am and what I want, my relationship with my partner or parents does not affect that.|eu",
"I have trouble separating my point of view or opinion from that of my parents or partner. | I have no trouble separating my point of view or opinion from that of my parents or partner.|eu",
"I feel that I have no privacy when it comes to my parents or partner. | I feel that I have appropriate privacy when it comes to my parents or partner.|eu",
"I feel that my parents would be hurt by me living away from them on my own. | I feel that my parents would fine if I lived away from them on my own.|eu",
"I let other people have their way, because I fear what might happen. | I tell other people what I want, negotiation is healthy.|sb",
"I believe that if I do what I want, I am only asking for trouble. | I believe that if I do what I want, that is a reasonable thing to do.|sb",
"I have no choice but to give in to other peoples wishes, or else they will retaliate or reject me in some way. | I do not have to give in to other peoples wishes, they will not retaliate or reject me in some way.|sb",
"In relationships, I let the other person have the upper hand. | In relationships, I do not let the other person have the upper hand.|sb",
"I have let others make choices for me, so I really do not know what I want for myself. | I have not let others make choices for me, I know what I want for myself.|sb",
"I feel the major decisions in my life were not really my own. | I feel the major decisions in my life were my own.|sb",
"I worry about pleasing other people, so they will not reject me. | I do not worry about pleasing other people, I do not worry they will reject me.|sb",
"I have trouble demanding that my rights be respected and that my feelings be considered. | I have no trouble demanding that my rights be respected and that my feelings be considered.|sb",
"I get back at people in little ways instead of showing my anger directly. | I am happy to show my anger directly, I do not try to get back at people in little ways.|sb",
"I will go to greater lengths than most people to avoid confrontations. | I do not try to avoid confrontations if they are appropriate.|sb",
"I put others needs before my own, or else I feel guilty. | I do not feel guilty to put my needs forward as important as other peoples.|ss",
"I feel guilty when I let other people down or disappoint them. | I tend not to feel guilty if I let other people down or disappoint them.|ss",
"I give more to other people than I get back in return. | I get more from other people than I give back in return.|ss",
"I am the one who usually ends up taking care of the people I am close to. | I not usually the one who ends up taking care of the people I am close to.|ss",
"There is almost nothing I could not put up with if I loved someone. | Even if I loved someone very much, there are limits to what I could put up with.|ss",
"I am a good person because I think of others more than of myself. | I am a good person because I take care of myself first, to let me then think of others.|ss",
"At work, I am usually the one to volunteer to do extra tasks or to put in extra time. | At work, I am seldom the one to volunteer to do extra tasks or to put in extra time.|ss",
"No matter how busy I am, I can always find time for others. | When I am very busy, I have no problem ignoring others problems until I have time.|ss",
"I can get by on very little, because my needs are minimal. | I have specific expectations and needs, my needs are appropriate.|ss",
"I am only happy when those around me are happy. | I can be happy even when those around me are not.|ss",
"I am so busy doing for the people that I care about that I have little time for myself. | I always make time for myself before also taking time to do things for the people that I care about.|ss",
"I have always been the one who listens to everyone elses problems. | I have not usually been the one who listens to everyone elses problems.|ss",
"I am happier to give a present than to receive one. | I am happier to receive a present than to give one.|ss",
"Other people see me as doing too much for others and not enough for myself. | Other people see me as doing too much for myself and not enough for others.|ss",
"No matter how much I give, I feel it is never enough. | I feel I give enough to others.|ss",
"If I do what I want, I feel very uncomfortable. | If I do what I want, I usually feel comfortable with my choices.|ss",
"It is very difficult for me to ask others to take care of my needs. | It is not difficult for me to ask others to take care of my needs.|ss",
"I worry about losing control of my actions. | I do not worry about losing control of my actions.|ei",
"I worry that I might seriously physically or emotionally hurt someone if my anger gets out of control. | I have self-control; I do not worry that I might hurt someone in any way even if I get very angry.|ei",
"I must control how I feel and be careful in how I act, or something bad is likely to happen. | I do not need to concentrate on controlling how I feel or act, I will not do something impetuous or bad.|ei",
"A lot of anger and resentment builds up inside of me that I do not express. | I do not tend to experience anger or resentment building up inside of me.|ei",
"I am too self-conscious to show positive feelings to others (eg, being nice first, showing I care). | I have no problem showing positive feelings to others (eg, being nice first, showing I care).|ei",
"I find it embarrassing to express my feelings to others. | I find it enjoyable to express my feelings to others.|ei",
"I find it hard to be warm or to start fun conversations without thinking about it first. | I find it easy to be warm or to start fun conversations without thinking about it first.|ei",
"I control myself so much that people think I am unemotional. | I do have to try  to control myself so much that people think I am unemotional.|ei",
"People see me as uptight and think that I do not show my feelings. | People do not see me as uptight and know I am happy to show my feelings.|ei",
"I must be the best at most of what I do; I cannot accept second best. | I am happy to do a reasonable job; I do not need to be best all the time.|us",
"I strive to keep almost everything in perfect order. | I am not a perfectionist|us",
"I must look my best most of the time. | I don't worry overmuch about my appearance.|us",
"I try to do my best; I cannot settle for good enough. | Good enough is sufficient|us",
"I have so much to accomplish that there is almost no time to really relax. | There is time for both relaxation and to accomplish my goals.|us",
"Almost nothing I do is quite good enough; I can always do better. | What I am doing is good enough; I can get better but I'm not obsessed with it.|us",
"I must meet all my responsibilities. | If I miss a few of my responsibilities, that is ok.|us",
"I feel there is constant pressure for me to achieve and get things done. | I do not feel pressure for me to achieve and get things done.|us",
"My relationships suffer because I push myself so hard. | I have a good balance between my relationships and my work.|us",
"My health is suffering because I put myself under so much pressure to do well. | I take care of my health first, even if this impact my ability to do other things.|us",
"I often sacrifice pleasure and happiness to meet my own standards. | My pleasure and happiness is important, even if standards slip a bit sometimes.|us",
"When I make a mistake, I deserve strong criticism. | When I make a mistake, I can learn from it and criticism is not useful.|us",
"I cannot let myself off the hook easily or make excuses for my mistakes. | I do not feel on the hook for my mistakes, there are often valid reasons for the failure.|us",
"I am a very competitive person. | I am not a very competitive person.|us",
"I put a good deal of emphasis on money or status. | I do not tend to put much emphasis on money or status.|us",
"I have to be Number One, in terms of my performance. | I do not have to be Number One, in terms of my performance.|us",
"I have trouble accepting no for an answer when I want something from other people. | I can accept no for an answer when I want something from other people.|et",
"I often get angry or irritable if I cannot get what I want. | I tend not to get angry or irritable if I cannot get what I want.|et",
"I am special and should not have to accept many of the rules placed on other people. | I am similar to everyone else and should therefore accept the rules placed on other people.|et",
"I hate to be constrained or kept from doing what I want. | It is reasonable for me to be constrained or kept from doing what I want when appropriate.|et",
"I feel that I should not have to follow the normal conventions and rules that other people do. | I should follow the normal conventions and rules that other people do.|et",
"What I have to offer is usually of greater value than the contributions of others. | What I have to offer is of no greater value than the contributions of others.|et",
"I usually put my needs ahead of the needs of others. | I try not to put my needs ahead of the needs of others.|et",
"I find that I am so involved in my own plans and actions that I often do not have time to give to friends or family. | I am not so involved in my own plans and actions that I cannot find time to give to friends or family.|et",
"People tell me I am very controlling about how things are done. | People do not find me to be very controlling about how things are done.|et",
"I get irritated when people will not do what I ask of them. | I can accept it when people will not do what I ask of them.|et",
"I cannot tolerate other people telling me what to do. | I do not mind other people telling me what to do.|et",
"I have difficulty getting myself to stop drinking, overeating, or other problem behaviors. | I have control over my drinking, eating, and other potentially problem behaviors.|is",
"I cannot discipline myself to complete routine or boring tasks. | I can discipline myself to complete routine or boring tasks.|is",
"I tend to carry through on impulses and express emotions that get me into trouble or hurt other people. | I do not carry through on impulses or express emotions that get me into trouble or hurt other people.|is",
"If I cannot reach a goal, I become easily frustrated and give up. | If I cannot reach a goal, I can persist and keep working toward it.|is",
"I find it hard to put off what I want right now in order to get what I want in the future. | I find it easy to put off what I want right now in order to get what I want in the future.|is",
"Once I start to feel angry, I usually just cannot control it. | Once I start to feel angry, I can usually control it.|is",
"I tend to overdo things, even though I know they are bad for me. | I do not overdo things, I know when things are bad for me and I stop.|is",
"I get bored very easily. | I do not get bored very easily.|is",
"When tasks become difficult, I usually stop and cannot complete them. | When tasks become difficult, I press on until I complete them.|is",
"I cannot concentrate on anything for too long. | I can concentrate for a fair period on any task.|is",
"I cannot force myself to do things I do not enjoy, even when I know it is for my own good. | I can force myself to do things I do not enjoy, when I know it is for my own good.|is",
"I lose my temper at the slightest offense. | I have control of my temper, slight offenses do not bother me.|is",
"I have rarely been able to stick to my resolutions. | I have usually been able to stick to my resolutions.|is",
"I usually cannot hold back from showing people how I feel, no matter what the cost may be. | I usually can hold back from showing people how I feel when appropriate to do so.|is",
"I often do things without thinking that I later regret. | I seldom do things without thinking that I later regret.|is",
"It is important to me to be liked by almost everyone I know. | It is not that important to me to be liked by almost everyone I know.|as",
"I change myself depending on the people I am with, so they will like me more. | I do not change myself depending on the people I am with, people should like me as I am.|as",
"I try hard to fit in. | I do not try to fit in, I am who I am.|as",
"My feelings about myself are based mostly on how other people view me. | My feelings about myself are not based on how other people view me.|as",
"Having money and knowing important people make me feel worthwhile. | Having money and knowing important people is not a big part of making me feel worthwhile.|as",
"I spend a lot of time on my physical appearance so people value me. | I do not spend a lot of time on my physical appearance to try to get people value me more.|as",
"My successes are most valuable to me when other people notice them. | My successes are valuable to me whether or not other people notice them.|as",
"I am so focused on fitting in that sometimes I do not know who I am. | I am never so focused on fitting in that  I do not know who I am.|as",
"When setting my own goals, I usually thinking about how others will view them. | When setting my own goals, I seldom think about how others will view them.|as",
"When I look back at my life decisions, I see that getting other peoples approval was an important part of the decision. | When I look back at my life decisions, I see that getting other peoples approval was not part of the decision.|as",
"Even if I do not like someone, I still want him or her to like me. | If I do not like someone, I do not care if they like me or not.|as",
"Unless I get a lot of attention from others, I feel less important. | I do not feel less important if I get less attention from others.|as",
"When I am introduced, or make remarks at a meeting, I enjoy the respect and admiration that follows. | When I am introduced, or make remarks at a meeting, the respect and admiration that follows is unimportant to me.|as",
"Lots of praise and compliments make me feel like a worthwhile person. | Lots of praise and compliments have little impact on how I feel about myself.|as",
"Even when things seem to be going well, I feel that it is only temporary. | When things seem to be going well, I feel that it is part of building something lasting.|np",
"If something good happens, I worry that something bad is likely to follow. | If something good happens, I do not worry that something bad is likely to follow.|np",
"You cannot be too careful; something will almost always go wrong. | In any project something will almost always go wrong, you can fix it so don't worry.|np",
"No matter how hard I work, I worry that I could lose all my money. | The money I have worked for is secure and I will not lose it.|np",
"I worry that a wrong decision could lead to disaster. | I will make some wrong decisions but they are not a disaster and can be changed.|np",
"I can obsess over minor decisions, because making a mistake seems so serious. | I do not obsess over minor decisions, any mistake can be easily fixed.|np",
"It is better assuming that things will not work out for me, that way I do not feel disappointed if things go wrong. | It is better assuming that things will work out for me, if things go wrong I can fix them and it will work in the end.|np",
"I focus more on the negative aspects of life and of events than on the positive. | I focus more on the positive aspects of life and of events than on the negative.|np",
"I tend to be pessimistic. | I tend to be optimistic.|np",
"People close to me consider me a worrier. | People close to me do not consider me a worrier.|np",
"If people get too enthusiastic about something, I become uncomfortable and feel like warning them of what could go wrong. | If people get enthusiastic about something, I enjoy it and join in on their enthusiasm.|np",
"If I make a mistake, I deserve to be punished. | If I make a mistake, I deserve to be given a second chance.|pu",
"If I do not try my hardest, I should expect to lose out. | If I do not try my hardest, I should expect to still do ok.|pu",
"There is no excuse if I make a mistake. | Everyone makes a mistakes.  If I make one that’s ok.|pu",
"People who do not pull their own weight should get punished in some way. | People who do not pull their own weight should be understood and supported to do better.|pu",
"Usually I do not accept the excuses other people make. They are just not willing to accept responsibility and suffer what happens next. | I usually accept the excuses other people make, their reasons are often good and people mostly want to do their best.|pu",
"If I do not do the job, I should suffer whatever happens next. | If I do not do the job, I should be supported to do the job better, not punished.|pu",
"I often think about my mistakes and feel angry with myself. | I do not usually think about my mistakes, if I do it is with curiosity and to learn.|pu",
"When people do something bad, I have trouble applying the phrase, Forgive and forget. | When people do something bad, I am happy to say, Forgive and forget.|pu",
"I hold grudges, even after someone has apologized. | When someone has apologized, I do not hold a grudge.|pu",
"I get upset when I think someone has been let off the hook too easily. | If I think someone has been let off the hook too easily, I don't worry about it.|pu",
"I get angry when people make excuses for themselves, or blame other people for their problems. | When people make excuses for themselves or blame other people for their problems I am sympathetic.|pu",
"It does not matter why I make a mistake; when I do something wrong, I should pay the price. | When I make a mistake it matters why; when I do something wrong responsibility should be shared.|pu",
"I beat-up on myself a lot for things I screw up. | I do not beat-up on myself for things I screw up.|pu",
"I am a bad person who deserves to be punished | I am a not bad person and do not deserve to be punished.|pu"
        ];
        const CATEGORY_DATA = [
            
            {group: "DAR", category: "ds", descriptor: "Deep down I'm pretty ok", total: 15},
            {group: "DAR", category: "ed", descriptor: "My support network is good", total: 9},
            {group: "DAR", category: "ei", descriptor: "My feeling and emotions are well integrated", total: 9},
            {group: "DAR", category: "ma", descriptor: "I am trusting and trustworthy", total: 17},
            {group: "DAR", category: "si", descriptor: "I am important to others", total: 10},
            {group: "ERS", category: "as", descriptor: "I don't need approval to feel good about doing right", total: 14},
            {group: "ERS", category: "np", descriptor: "The world is a positive place with opportunities", total: 11},
            {group: "ERS", category: "pu", descriptor: "I don't tend to blame when bad things happen", total: 14},
            {group: "ERS", category: "ss", descriptor: "I value my time and attention", total: 17},
            {group: "ERS", category: "us", descriptor: "I am a good judge of good-enough", total: 16},
            {group: "IAP", category: "ab", descriptor: "People like to have me around", total: 17},
            {group: "IAP", category: "di", descriptor: "I am pretty independent", total: 15},
            {group: "IAP", category: "eu", descriptor: "I know my own mind", total: 11},
            {group: "IAP", category: "fa", descriptor: "When I try, I usually succeed", total: 9},
            {group: "IAP", category: "sb", descriptor: "I can balance my own needs well with others", total: 10},
            {group: "IAP", category: "vu", descriptor: "I'm pretty safe and secure in my life", total: 12},
            {group: "IL", category: "et", descriptor: "I can take in other viewpoints", total: 11},
            {group: "IL", category: "is", descriptor: "I have good self-control", total: 15}
        ];
        const STRENGTHEN_INSTRUCTION = document.getElementById('strengthen-instruction');
        const SELECTED_DROP_DELAY = 800; // Delay in ms before animating selected cards to containers after 4th selection
        const SELECTED_DROP_Y = '20px'; // Amount to drop selected cards
        const SELECTED_SCALE = 0.9; // Shrink factor for selected cards
        const SELECTED_FONT_SCALE = 0.9; // Font size scale factor (original front font-size is 16px)
        const BORDER_WIDTH = '3px'; // Border width for selected cards
        const TOTAL_QUESTIONS = 232; // Total number of questions in the game
        const CARDS_PER_SET = 5; // Number of cards drawn per set
        const ENCODED_DIGITS = 92;
        const FINAL_LENGTH = 93;
        // Color constants (orange for selected/resonant, light green for rejected)
        const SELECTED_BG = '#FFA500';
        const DARKENED_SELECTED_BG = '#C97814';
        const SELECTED_BORDER = '#C97814';
        const REJECTED_BG = '#90EE90';
        const DARKENED_REJECTED_BG = '#006400';
        const REJECTED_BORDER = '#006400';
        const BASE = BigInt(58); // Base for encoding
        const BASE58_DIGITS = '23456789ABCDEFGHIJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz'; // Digits for base58 encoding (excludes 0,1,l,O)
        const GROUP_COLORS = { // Colors for groups in results (unused in current code but defined)
            DAR: '#0000FF',
            ERS: '#FF00FF',
            IAP: '#800080',
            IL: '#FF0000'
        };
        const INITIAL_PROMPT = `You are about to go through an interactive experience that will ask you some questions you may find very sensitive.\n
This session is totally anonymous,
your name is not recorded and no-one can see what you enter.\n
At the end of the session you will get a results summary.
This should give you insight into some of your deeper motivations and potential blockers to your learning.\n
This can be very useful for your coach. It is up to you to forward your results at the end. If you take no action, all data is deleted\n
To forward your results, just copy and paste your results summary at the end into an email and send it.\n
The full session will take 20 to 30 minutes
When you are ready to progress click continue\n\n\n\n\n\n\n\n`; // Initial prompt shown on load
        const GAME_INTRO_INSTRUCTION =
`You will soon be offered 47 card hands,
Each hand has 5 cards,
Each card has a statement.\n
Choose the card that you identify with most.\n
Try clicking 'Reverse Sentiment' to see the opposite statements.
Play with Reversing Sentiment and choosing cards until 4 cards are chosen. You can Undo your last pick at any time.\n
If a statement really resonates with you,
click on an already selected card again to strengthen it.
The 5th card in any set goes "grey" automatically (unsure)\n
When you are ready to start click continue\n\n\n\n\n\n`; // Introduction to game mechanics
        const BEGIN_GAME_INSTRUCTION = "Click continue to begin the game"; // Prompt after intro
        const CLICK_ANY_CARD = " Click any card to begin\n\n\n\n"; // Prompt to start selecting
        const CHOOSE_MOST_LIKE_YOU = " choose the card MOST like you\n (if none then reverse sentiment)\n\n\n\n"; // Prompt during selection
        const ALL_SETS_COMPLETED_INSTRUCTION = "All sets completed! Click Continue to proceed to the next phase."; // End of selection phase
        const UPDATE_RED_INSTRUCTION = "You have completed the first phase of the game.\nYou likely had to choose some cards (both red and green) that you felt more strongly than others.The grey cards were what was left, probably most of these are in-between.\n\nThe next section lets you change some of those cards.\n\nWhen you click below, a 2 minute timer will appear.\n\nYou can now hover your mouse over any red card, you will see the statement you chose. You can click to strengthen that card (darker red) or to weaken it (grey).\n\nYou can click as many bricks as you like during the 2 minute period.\nPlease click on Continue when you are ready."; // Instruction for red update phase
        const UPDATE_GREEN_INSTRUCTION = "Thank you for updating your red bricks.\nNow please update your green bricks in the same way.\n\nEach green brick represents a card you have chosen that resonates with you. If you want to change your choice, click to change to red -- or grey if not sure.\n\nPlease click on Continue when you are ready."; // Instruction for green update phase
        const UPDATE_GREY_INSTRUCTION = "Now you will have 2 minutes to update your grey bricks. These represent the cards that you neither rejected or selected.\n\nClick on any grey brick to change it to green, and again to change it to red.\n\nPlease click on Continue when you are ready."; // Instruction for grey update phase
        const RESULTS_HTML = '<h2>Results</h2><pre></pre>'; // Initial HTML for results container
const ALLSELECTIONS_TEST = ''; // 232-digit string of digits 0-4 for testing encoding (0: dark rejected, 1: light rejected, 2: grey, 3: light selected, 4: dark selected)
        const COPY_SUCCESS_MESSAGE = 'Results copied to clipboard!'; // Alert on successful copy
        const COPY_FAIL_MESSAGE = 'Failed to copy results.'; // Alert on failed copy
        const questionsData = QUESTIONS_DATA;
        const categoryData = CATEGORY_DATA;
        const questionsByCategory = {};
        questionsData.forEach(line => {
            const [question, opposite, category] = line.split('|');
            if (question && category) {
                if (!questionsByCategory[category]) {
                    questionsByCategory[category] = [];
                }
                questionsByCategory[category].push({ question, opposite });
            }
        });
        const selectedSelections = {};
        const rejectedSelections = {};
        const allSelections = [];
        const remainingQuestionsByCategory = JSON.parse(JSON.stringify(questionsByCategory));
        categoryData.forEach(({category}) => {
            selectedSelections[category] = 0;
            rejectedSelections[category] = 0;
        });
        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }
const totalSets = Math.floor(TOTAL_QUESTIONS / CARDS_PER_SET);
let currentSetIndex = 0;
let selectedCards = [];
let removeFromTop = true;
let isFlipped = false;
let selectionCount = 0;
let isAnimating = false;
let updatePhase = null;
let timerInterval = null;
let cards = [];
const instruction = document.getElementById('instruction');
const progressContainer = document.getElementById('progress-container');
const continueButton = document.getElementById('continue-button');
const reverseButton = document.getElementById('reverse-button');
const allQuestions = [];
for (const category in questionsByCategory) {
    allQuestions.push(...questionsByCategory[category].map(q => ({ text: q.question, opposite: q.opposite, category })));
}
shuffle(allQuestions);
// Delay creation of blue bricks until second "Continue" click
function getNextSet() {
    const availableQuestions = [];
    for (const category in remainingQuestionsByCategory) {
        availableQuestions.push(...remainingQuestionsByCategory[category].map(q => ({ text: q.question, opposite: q.opposite, category })));
    }
    if (availableQuestions.length < CARDS_PER_SET && availableQuestions.length > 0) {
        return availableQuestions.splice(0, availableQuestions.length);
    }
    if (availableQuestions.length === 0) return null;
    shuffle(availableQuestions);
    const set = [];
    const availableCategories = Object.keys(remainingQuestionsByCategory).filter(c => remainingQuestionsByCategory[c].length > 0);
    if (availableCategories.length >= CARDS_PER_SET) {
        const affinity = {};
        for (const category in remainingQuestionsByCategory) {
            const selected = selectedSelections[category] || 0;
            const rejected = rejectedSelections[category] || 0;
            affinity[category] = selected - rejected;
        }
        let possibleQuintets = [];
        for (let i = 0; i < availableCategories.length; i++) {
            for (let j = i + 1; j < availableCategories.length; j++) {
                for (let k = j + 1; k < availableCategories.length; k++) {
                    for (let m = k + 1; m < availableCategories.length; m++) {
                        for (let n = m + 1; n < availableCategories.length; n++) {
                            const quintet = [availableCategories[i], availableCategories[j], availableCategories[k], availableCategories[m], availableCategories[n]];
                            const score = Math.abs(affinity[quintet[0]] - affinity[quintet[1]]) +
                                          Math.abs(affinity[quintet[0]] - affinity[quintet[2]]) +
                                          Math.abs(affinity[quintet[0]] - affinity[quintet[3]]) +
                                          Math.abs(affinity[quintet[0]] - affinity[quintet[4]]) +
                                          Math.abs(affinity[quintet[1]] - affinity[quintet[2]]) +
                                          Math.abs(affinity[quintet[1]] - affinity[quintet[3]]) +
                                          Math.abs(affinity[quintet[1]] - affinity[quintet[4]]) +
                                          Math.abs(affinity[quintet[2]] - affinity[quintet[3]]) +
                                          Math.abs(affinity[quintet[2]] - affinity[quintet[4]]) +
                                          Math.abs(affinity[quintet[3]] - affinity[quintet[4]]);
                            possibleQuintets.push({quintet, score});
                        }
                    }
                }
            }
        }
        if (possibleQuintets.length > 0) {
            possibleQuintets.sort((a, b) => b.score - a.score);
            const bestQuintet = possibleQuintets[0].quintet;
            for (const category of bestQuintet) {
                const questions = remainingQuestionsByCategory[category];
                const idx = Math.floor(Math.random() * questions.length);
                const question = questions.splice(idx, 1)[0];
                set.push({ text: question.question, opposite: question.opposite, category });
            }
            return set;
        }
    }
    for (let i = 0; i < CARDS_PER_SET && availableQuestions.length > 0; i++) {
        const question = availableQuestions.shift();
        set.push(question);
        remainingQuestionsByCategory[question.category] = remainingQuestionsByCategory[question.category].filter(q => q.question !== question.text);
    }
    return set;
}
function animateCardToContainer(card, containerId, iconClass, text, opposite, category, callback, isDarkened = false) {
    console.log(`animateCardToContainer: Adding ${iconClass} to ${containerId}, text=${text}, category=${category}`);
    const initialRect = card.getBoundingClientRect();
    const frontClone = card.querySelector('.front').cloneNode(true);
    frontClone.className = 'temp-icon';
    frontClone.style.left = initialRect.left + 'px';
    frontClone.style.top = initialRect.top + 'px';
    frontClone.style.width = initialRect.width + 'px';
    frontClone.style.height = initialRect.height + 'px';
    frontClone.style.opacity = '1';
    document.body.appendChild(frontClone);
    const actualIcon = document.createElement('div');
    actualIcon.className = iconClass;
    if (isDarkened && iconClass !== 'neither-icon') {
        actualIcon.classList.add('darkened');
    }
    actualIcon.dataset.tooltip = iconClass === 'rejected-icon' ? opposite : text;
    actualIcon.dataset.opposite = opposite;
    actualIcon.dataset.category = category;
    actualIcon.dataset.text = text;
    actualIcon.style.visibility = 'hidden';
    const container = document.getElementById(containerId);
    container.appendChild(actualIcon);
    // Add tooltip for red, green, and grey bricks
    const tooltip = document.createElement('div');
    tooltip.className = 'tooltip';
    tooltip.textContent = actualIcon.dataset.tooltip;
    actualIcon.appendChild(tooltip);
    // Add click listener with full behavior
    let lastClickTime = 0;
    const debounceDelay = 200;
    actualIcon.addEventListener('click', () => {
        const now = Date.now();
        if (now - lastClickTime < debounceDelay) return;
        lastClickTime = now;
        const currentContainerId = actualIcon.parentNode.id;
        const currentText = actualIcon.dataset.text;
        const currentOpposite = actualIcon.dataset.opposite;
        const currentCategory = actualIcon.dataset.category;
        let currentBrickStatus = actualIcon.classList.contains('rejected-icon') ? 'rejected' :
                                  actualIcon.classList.contains('selected-icon') ? 'selected' : 'grey';
        const selection = allSelections.find(sel => sel.text === currentText && sel.status === currentBrickStatus);
        if (selection) {
            let newStatus = currentBrickStatus;
            let newClass = actualIcon.className.replace(' darkened', '').replace('darkened', '');
            let nextTooltip = actualIcon.dataset.tooltip;
            if (currentContainerId === 'rejected-container' || currentContainerId === 'selected-container') {
                actualIcon.classList.toggle('darkened');
                const selection = allSelections.find(sel => sel.text === currentText);
if (selection) selection.darkened = actualIcon.classList.contains('darkened');
            } else if (currentContainerId === 'neither-container') {
                actualIcon.classList.remove('darkened');
                if (currentBrickStatus === 'grey') {
                    newStatus = 'selected';
                    newClass = 'selected-icon';
                    selectedSelections[currentCategory] = (selectedSelections[currentCategory] || 0) + 1;
                    nextTooltip = currentText;
                } else if (currentBrickStatus === 'selected') {
                    newStatus = 'rejected';
                    newClass = 'rejected-icon';
                    selectedSelections[currentCategory] = (selectedSelections[currentCategory] || 0) - 1;
                    rejectedSelections[currentCategory] = (rejectedSelections[currentCategory] || 0) + 1;
                    nextTooltip = currentOpposite;
                } else if (currentBrickStatus === 'rejected') {
                    newStatus = 'grey';
                    newClass = 'neither-icon';
                    rejectedSelections[currentCategory] = (rejectedSelections[currentCategory] || 0) - 1;
                    nextTooltip = currentText;
                }
                selection.status = newStatus;
                selection.darkened = false;
                actualIcon.className = newClass;
                const oldTooltip = actualIcon.querySelector('.tooltip');
                if (oldTooltip) actualIcon.removeChild(oldTooltip);
                const newTooltipElem = document.createElement('div');
                newTooltipElem.className = 'tooltip';
                newTooltipElem.textContent = nextTooltip;
                actualIcon.appendChild(newTooltipElem);
            }
        }
    }, { once: false });
    requestAnimationFrame(() => {
        const targetRect = actualIcon.getBoundingClientRect();
        requestAnimationFrame(() => {
            frontClone.style.left = targetRect.left + 'px';
            frontClone.style.top = targetRect.top + 'px';
            frontClone.style.width = targetRect.width + 'px';
            frontClone.style.height = targetRect.height + 'px';
            frontClone.style.opacity = '0';
        });
    });
    frontClone.addEventListener('transitionend', () => {
        document.body.removeChild(frontClone);
        actualIcon.style.visibility = 'visible';
        console.log(`animateCardToContainer: ${iconClass} made visible in ${containerId}`);
        if (callback) callback();
    }, { once: true });
}
function addNeitherIcon(text, opposite, category) {
    const icon = document.createElement('div');
    icon.className = 'neither-icon';
    icon.dataset.tooltip = text;
    icon.dataset.opposite = opposite;
    icon.dataset.category = category;
    icon.dataset.text = text;
    const tooltip = document.createElement('div');
    tooltip.className = 'tooltip';
    tooltip.textContent = text;
    icon.appendChild(tooltip);
    icon.addEventListener('click', () => {
        icon.classList.toggle('marked');
    });
    document.getElementById('neither-container').appendChild(icon);
    allSelections.push({ text, category, status: 'grey' });
}
function startUpdatePhase() {
    // Removed - directly go to results
    document.getElementById('game-container').style.display = 'none';
    displayResults();
}
    function bigIntToBase(n, base, digits) {
    if (n === 0n) return digits[0].repeat(ENCODED_DIGITS);
    let result = [];
    let temp = n;
    for (let i = 0; i < ENCODED_DIGITS; i++) {
        const digit = Number(temp % base);
        console.log(`Digit ${i}: ${digit}, Char: ${digits[digit]}`);
        result.push(digits[digit]);
        temp = temp / base;
    }
    return result.reverse().join('');
}
function displayResults() {
    const resultsContainer = document.getElementById('results-container');
    resultsContainer.style.display = 'flex';
    resultsContainer.innerHTML = RESULTS_HTML;
    const copyButton = document.getElementById('copy-button');
    copyButton.style.display = 'block';
    const groupColors = GROUP_COLORS;
    const base58Digits = BASE58_DIGITS;
    const maxDescriptorLength = Math.max(...categoryData.map(({descriptor}) => descriptor.length));
    const scores = questionsData.map((line, index) => {
    const [question, , category] = line.split('|');
    const trimmedQuestion = question.trim();
    const selection = allSelections.find(sel => sel.text.trim() === trimmedQuestion && sel.category === category);
    let score;
    if (selection) {
        if (selection.status === 'rejected') {  //green
            score = selection.darkened ? 0 : 1;
        } else if (selection.status === 'selected') {  //orange
            score = selection.darkened ? 4 : 3;
        } else {
            score = 2;
        }
    } else {
        score = 2;
    }
    console.log(`Encode Question ${index + 1}: "${trimmedQuestion}", Category: ${category}, Selection:`, selection, `Score: ${score}`);
    return score;
});
    console.log('Encoded scores:', scores);
const categoryScores = {};
questionsData.forEach((line, index) => {
    const [ , , category ] = line.split('|');
    if (!categoryScores[category]) {
        categoryScores[category] = { sumMarks: 0, totalQuestions: 0 };
    }
    categoryScores[category].totalQuestions++;
    let points = 0;
    if (scores[index] === 0) points = 4;
    else if (scores[index] === 1) points = 3;
    else if (scores[index] === 2) points = 1;
    categoryScores[category].sumMarks += points;
});
const sortedByGroup = categoryData.reduce((acc, {group, category, descriptor, total}) => {
    const { sumMarks, totalQuestions } = categoryScores[category] || { sumMarks: 0, totalQuestions: total };
    const maxMarks = 4 * totalQuestions;
    const percentage = Math.round((sumMarks / maxMarks) * 100);
    if (!acc[group]) acc[group] = [];
    acc[group].push({category, descriptor, percentage, total});
    return acc;
}, {DAR: [], ERS: [], IAP: [], IL: []});
const barChart = ['DAR', 'ERS', 'IAP', 'IL'].flatMap(group => {
    const categories = sortedByGroup[group].sort((a, b) => b.percentage - a.percentage);
    return categories.map(({descriptor, percentage}) => {
        const stars = '*'.repeat(Math.round(percentage / 10));
        const paddedDescriptor = descriptor.padEnd(maxDescriptorLength, ' ');
        return `${paddedDescriptor}: ${stars} (${percentage}%)`;
    });
}).join('\n');
let number = BigInt(0);
for (let i = 0; i < scores.length; i++) {
    number = number * BigInt(5) + BigInt(scores[i]);
}
    console.log('Input number to bigIntToBase:', number);
    const encoded = bigIntToBase(number, BASE, base58Digits);
    if (encoded.length !== ENCODED_DIGITS) {
        console.error('Encoded string length invalid:', encoded.length);
        resultsContainer.querySelector('pre').innerHTML = 'Error: Invalid encoded string length';
        return;
    }
    for (let char of encoded) {
        if (base58Digits.indexOf(char) === -1) {
            console.error('Invalid character in encoded string:', char);
            resultsContainer.querySelector('pre').innerHTML = 'Error: Invalid character in encoded string';
            return;
        }
    }
    let sum = 0n;
    for (let char of encoded) {
        sum += BigInt(base58Digits.indexOf(char));
    }
    const checksum = Number(sum % BASE);
    console.log('Encoded checksum:', checksum, 'Checksum character:', base58Digits[checksum]);
    const resultString = encoded + base58Digits[checksum];
    console.log('Encoded resultString:', resultString);
    if (resultString.length !== FINAL_LENGTH) {
        console.error('Final result string length invalid:', resultString.length);
        resultsContainer.querySelector('pre').innerHTML = 'Error: Invalid final result string length';
        return;
    }
let formattedResult = '';
for (let l = 0; l < 3; l++) {
    let line = resultString.substring(l*31, (l+1)*31);
    formattedResult += line.substring(0,7) + ' ' + line.substring(7,13) + ' ' + line.substring(13,19) + ' ' + line.substring(19,25) + ' ' + line.substring(25,31) + '\n';
}
formattedResult = formattedResult.trim();
    const outputText = barChart + '\n\nResult Sequence:\n' + formattedResult;
    resultsContainer.querySelector('pre').innerHTML = outputText;
    copyButton.onclick = () => {
        navigator.clipboard.writeText(outputText).then(() => {
            alert(COPY_SUCCESS_MESSAGE);
        }).catch(err => {
            console.error('Failed to copy results:', err);
            alert(COPY_FAIL_MESSAGE);
        });
    };
}
function displaySet() {
    console.log('displaySet called, allSelections.length:', allSelections.length, 'remainingQuestionsByCategory:', remainingQuestionsByCategory, 'progressContainer.children.length:', progressContainer.children.length);
    // Line before the end-of-phase check
    console.log('Before end check, allSelections.length:', allSelections.length, 'remainingQuestionsByCategory:', remainingQuestionsByCategory, 'progressContainer.children.length:', progressContainer.children.length);
    // Check if all 232 questions are selected, no more sets are available, or all progress icons are used
    if (allSelections.length >= TOTAL_QUESTIONS || (remainingQuestionsByCategory && Object.values(remainingQuestionsByCategory).every(cat => cat.length === 0)) || progressContainer.children.length === 0) {
        console.log('After end check, condition met:', allSelections.length >= TOTAL_QUESTIONS || (remainingQuestionsByCategory && Object.values(remainingQuestionsByCategory).every(cat => cat.length === 0)) || progressContainer.children.length === 0, 'allSelections.length:', allSelections.length, 'remainingQuestionsByCategory empty:', Object.values(remainingQuestionsByCategory).every(cat => cat.length === 0), 'progressContainer.children.length:', progressContainer.children.length);
        console.log('End of card phase detected, preparing to transition, allSelections.length:', allSelections.length, 'progressContainer.children.length:', progressContainer.children.length);
        const availableQuestions = [];
        for (const category in remainingQuestionsByCategory) {
            availableQuestions.push(...remainingQuestionsByCategory[category].map(q => ({ text: q.question, opposite: q.opposite, category })));
        }
        if (availableQuestions.length > 0 && availableQuestions.length <= 4) {
            console.log('Handling remaining questions:', availableQuestions.length);
            availableQuestions.forEach(q => {
                allSelections.push({ text: q.text, category: q.category, status: 'grey' });
                remainingQuestionsByCategory[q.category] = remainingQuestionsByCategory[q.category].filter(r => r.question !== q.text);
                if (progressContainer.lastChild) {
                    progressContainer.removeChild(progressContainer.lastChild);
                }
            });
            console.log('Updated allSelections.length:', allSelections.length, 'progressContainer.children.length:', progressContainer.children.length);
        }
        instruction.innerText = ALL_SETS_COMPLETED_INSTRUCTION;
        cards.forEach(card => {
            card.style.display = 'none';
        });
        document.getElementById('undo-button').style.display = 'none';
        document.getElementById('reverse-button').style.display = 'none';
        document.getElementById('auto-progress').style.display = 'none';
        document.getElementById('game-container').style.display = 'block';
        console.log('Initiating phase transition, calling startUpdatePhase directly');
document.getElementById('game-container').style.display = 'none';
displayResults();
        console.log('startUpdatePhase called, continueButton setup to follow');
        // Optional manual continue button as fallback
        console.log('Setting continueButton.style.display to block, continueButton:', continueButton);
        continueButton.style.display = 'block';
        continueButton.style.zIndex = '1200';
        continueButton.style.position = 'relative';
        console.log('continueButton.style.display set to:', continueButton.style.display);
        continueButton.addEventListener('click', () => {
            console.log('Continue button clicked, starting update phase manually, progressContainer.children.length:', progressContainer.children.length);
document.getElementById('game-container').style.display = 'none';
displayResults();
            continueButton.style.display = 'none';
        }, { once: true });
        console.log('Event listener attached to continueButton, continueButton:', continueButton);
        continueButton.focus();
        return;
    }
    const set = getNextSet();
    console.log('getNextSet returned set:', set, 'allSelections.length:', allSelections.length, 'progressContainer.children.length:', progressContainer.children.length);
    if (!set) {
        console.log('No more sets available, triggering end of card phase, allSelections.length:', allSelections.length, 'progressContainer.children.length:', progressContainer.children.length);
        instruction.innerText = ALL_SETS_COMPLETED_INSTRUCTION;
        cards.forEach(card => {
            card.style.display = 'none';
        });
        document.getElementById('undo-button').style.display = 'none';
        document.getElementById('reverse-button').style.display = 'none';
        document.getElementById('auto-progress').style.display = 'none';
        document.getElementById('game-container').style.display = 'block';
        console.log('Initiating phase transition, calling startUpdatePhase directly');
        startUpdatePhase(); // Direct call to ensure phase transition
        console.log('startUpdatePhase called, continueButton setup to follow');
        // Optional manual continue button as fallback
        console.log('Setting continueButton.style.display to block, continueButton:', continueButton);
        continueButton.style.display = 'block';
        continueButton.style.zIndex = '1200';
        continueButton.style.position = 'relative';
        console.log('continueButton.style.display set to:', continueButton.style.display);
        continueButton.addEventListener('click', () => {
            console.log('Continue button clicked, starting update phase manually, progressContainer.children.length:', progressContainer.children.length);
            startUpdatePhase();
            continueButton.style.display = 'none';
        }, { once: true });
        console.log('Event listener attached to continueButton, continueButton:', continueButton);
        continueButton.focus();
        return;
    }
if (removeFromTop) {
    if (progressContainer.firstChild) {
        progressContainer.removeChild(progressContainer.firstChild);
    }
} else {
    if (progressContainer.lastChild) {
        progressContainer.removeChild(progressContainer.lastChild);
    }
}
    removeFromTop = !removeFromTop;
    const numIcons = progressContainer.children.length;
const numRows = Math.ceil(numIcons / 10);
progressContainer.style.gridTemplateRows = `repeat(${numRows}, 70px)`;
progressContainer.style.height = `calc((70px + 16px) * ${numRows} - 16px)`;
    cards.forEach((card, index) => {
        if (index < set.length) {
card.classList.remove('selected-card', 'selected', 'rejected', 'grey', 'darkened');
card.style.border = 'none';
card.style.fontSize = '16px'; // Reset to original
card.style.removeProperty('--dark-color');
            card.querySelector('.front').innerText = set[index].text;
            card.querySelector('.front').style.backgroundColor = SELECTED_BG;
            const front = card.querySelector('.front');
            front.style.fontWeight = 'normal';
            card.dataset.category = set[index].category;
            card.dataset.text = set[index].text;
            card.dataset.opposite = set[index].opposite;
            card.style.display = 'block';
            card.style.visibility = 'visible';
            card.style.transform = '';
            card.style.opacity = '1';
            card.classList.remove('flipped', 'slide-down', 'slide-up', 'selected');
            card.removeAttribute('title'); // Remove card tooltip
        } else {
            card.style.display = 'none';
        }
    });
    isFlipped = false;
    selectionCount = 0;
    selectedCards = [];
    isAnimating = false;
    instruction.innerText = CLICK_ANY_CARD;
    document.getElementById('card-container').classList.add('selected-phase');
    document.getElementById('undo-button').style.display = 'none';
    document.getElementById('reverse-button').style.display = 'none';
    document.getElementById('reverse-button').style.backgroundColor = REJECTED_BG;
    document.getElementById('auto-progress').style.display = 'block'; // Show auto-progress button
    continueButton.style.display = 'none';
}
function flipCards() {
    cards.forEach(card => {
        if (card.style.display !== 'none') {
            card.classList.add('flipped');
            card.querySelector('.front').innerText = card.dataset.opposite;
            card.querySelector('.front').style.backgroundColor = REJECTED_BG;
            card.removeAttribute('title'); // Remove card tooltip
        }
    });
    isFlipped = true;
    selectionCount = 0;
    instruction.innerText = CHOOSE_MOST_LIKE_YOU;
    document.getElementById('card-container').classList.remove('selected-phase');
    document.getElementById('card-container').classList.add('rejected-phase');
    document.getElementById('undo-button').style.display = 'block';
    document.getElementById('reverse-button').style.display = 'block';
    document.getElementById('reverse-button').style.backgroundColor = SELECTED_BG;
}
        document.getElementById('continue-button').addEventListener('click', startGame, { once: true });
function startGame() {
    instruction.innerText = GAME_INTRO_INSTRUCTION;
    continueButton.style.display = 'block';
    continueButton.focus();
    continueButton.addEventListener('click', () => {
        continueButton.style.display = 'none';
        instruction.innerText = BEGIN_GAME_INSTRUCTION;
        continueButton.style.display = 'block';
        continueButton.focus();
        continueButton.addEventListener('click', () => {
            continueButton.style.display = 'none'; // Ensure button hides after second click
            instruction.style.zIndex = -1; // Move instruction behind game elements
            // Create and display blue bricks
            for (let i = 0; i < Math.ceil(TOTAL_QUESTIONS / CARDS_PER_SET); i++) {
                const icon = document.createElement('div');
                icon.className = 'progress-icon';
                icon.dataset.category = allQuestions[i].category;
                progressContainer.appendChild(icon);
                const existingTooltip = icon.querySelector('.tooltip');
                if (existingTooltip) icon.removeChild(existingTooltip);
            }
            document.getElementById('card-container').style.display = 'flex'; // Use inline style to ensure display
            document.getElementById('progress-container').style.display = 'grid';
            document.getElementById('selected-container').style.display = 'flex';
            document.getElementById('rejected-container').style.display = 'flex';
            document.getElementById('neither-container').style.display = 'flex';
            // Dynamically create cards and attach event listeners
            const cardContainer = document.getElementById('card-container');
            for (let i = 0; i < CARDS_PER_SET; i++) {
                const cardWrapper = document.createElement('div');
                cardWrapper.className = 'card-wrapper';
                const card = document.createElement('div');
                card.className = 'card';
                const back = document.createElement('div');
                back.className = 'back';
                back.style.background = 'repeating-linear-gradient(60deg, #1e90ff, #1e90ff 13px, #24588c 10px, #104e8b 20px)';
                const front = document.createElement('div');
                front.className = 'front';
                card.appendChild(back);
                card.appendChild(front);
                cardWrapper.appendChild(card);
                cardContainer.appendChild(cardWrapper);
                cards.push(card);
                // Attach click event listener to each new card
card.addEventListener('click', () => {
    if (card.style.display === 'none') return;
    if (!isFlipped) {
        flipCards();
    } else {
        if (card.classList.contains('selected-card')) {
            card.classList.toggle('darkened');
            const front = card.querySelector('.front');
            const status = card.classList.contains('selected') ? 'selected' : 'rejected';
            const isSelected = status === 'selected';
            const regularColor = isSelected ? SELECTED_BG : REJECTED_BG;
            const darkColor = isSelected ? DARKENED_SELECTED_BG : DARKENED_REJECTED_BG;
            if (card.classList.contains('darkened')) {
                front.style.setProperty('background-color', darkColor, 'important');
                front.style.setProperty('font-weight', 'bold', 'important');
            } else {
                front.style.setProperty('background-color', regularColor, 'important');
                front.style.setProperty('font-weight', 'normal', 'important');
            }
            const selection = allSelections.find(sel => sel.text === card.dataset.text);
            if (selection) selection.darkened = card.classList.contains('darkened');
            return;
        } else if (selectionCount < 4 && !isAnimating) {
            isAnimating = true;
            const isRejectPhase = document.getElementById('card-container').classList.contains('rejected-phase');
            const status = isRejectPhase ? 'rejected' : 'selected';
            const containerId = isRejectPhase ? 'rejected-container' : 'selected-container';
            const iconClass = isRejectPhase ? 'rejected-icon' : 'selected-icon';
            const text = card.dataset.text;
            const opposite = card.dataset.opposite;
            const category = card.dataset.category;
            if (status === 'rejected') {
                rejectedSelections[category] = (rejectedSelections[category] || 0) + 1;
            } else {
                selectedSelections[category] = (selectedSelections[category] || 0) + 1;
            }
            selectedCards.push({ card, status });
            // Apply drop, shrink, and border without animating to container yet
            card.classList.add('selected-card', status);
            card.style.transform = `translateY(${SELECTED_DROP_Y}) scale(${SELECTED_SCALE})`;
            card.style.fontSize = `${16 * SELECTED_FONT_SCALE}px`; // Adjust font size proportionally
            card.style.border = `${BORDER_WIDTH} solid ${status === 'selected' ? SELECTED_BORDER : REJECTED_BORDER}`;
            selectionCount++;
            allSelections.push({ text, category, status, darkened: false });
            if (selectionCount === 1) {
                STRENGTHEN_INSTRUCTION.style.display = 'block';
            }
            setTimeout(() => { // Small delay to complete drop animation
                if (selectionCount === 4 || (selectionCount < 4 && progressContainer.children.length === 0)) {
                    setTimeout(() => { // Delay before animating all to containers
                        selectedCards.forEach(({ card, status }) => {
                            const containerId = status === 'rejected' ? 'rejected-container' : 'selected-container';
                            const iconClass = status === 'rejected' ? 'rejected-icon' : 'selected-icon';
                            const text = card.dataset.text;
                            const opposite = card.dataset.opposite;
                            const category = card.dataset.category;
                            card.style.visibility = 'hidden';
                            animateCardToContainer(card, containerId, iconClass, text, opposite, category, () => {}, card.classList.contains('darkened'));
                        });
                        const remainingCard = Array.from(cards).find(c => c.style.display !== 'none' && !c.classList.contains('selected-card'));
                        if (remainingCard) {
                            const neitherText = remainingCard.dataset.text;
                            const neitherOpposite = remainingCard.dataset.opposite;
                            const neitherCategory = remainingCard.dataset.category;
                            // Apply drop/shrink/border to remaining card before animating
                            remainingCard.classList.add('selected-card', 'grey'); // Use grey for neither, but no border color needed
                            remainingCard.style.transform = `translateY(${SELECTED_DROP_Y}) scale(${SELECTED_SCALE})`;
                            remainingCard.style.fontSize = `${16 * SELECTED_FONT_SCALE}px`;
                            setTimeout(() => {
                                remainingCard.style.visibility = 'hidden';
                                animateCardToContainer(remainingCard, 'neither-container', 'neither-icon', neitherText, neitherOpposite, neitherCategory, () => {
                                    currentSetIndex++;
                                    displaySet();
                                });
                            }, SELECTED_DROP_DELAY);
                            allSelections.push({ text: neitherText, category: neitherCategory, status: 'grey', darkened: false });
                        } else {
                            currentSetIndex++;
                            displaySet();
                        }
                        selectedCards = []; // Reset after animation
                        STRENGTHEN_INSTRUCTION.style.display = 'none'; // Hide instruction after set completes
                    }, SELECTED_DROP_DELAY);
                } else {
                    instruction.innerText = CHOOSE_MOST_LIKE_YOU;
                    document.getElementById('undo-button').style.display = 'block';
                    document.getElementById('reverse-button').style.display = (CARDS_PER_SET - selectionCount) >= 2 ? 'block' : 'none';
                    document.getElementById('reverse-button').style.backgroundColor = isRejectPhase ? SELECTED_BG : REJECTED_BG;
                    isAnimating = false;
                }
            }, 300); // Short delay for drop animation
        }
    }
});
            }
            displaySet();
        }, { once: true });
    }, { once: true });
}
       instruction.innerText = INITIAL_PROMPT;
continueButton.style.display = 'block';
continueButton.focus();
function undoRejection() {
    if (selectedCards.length > 0 && selectionCount > 0) {
        const lastCard = selectedCards.pop();
        const category = lastCard.card.dataset.category;
        const question = lastCard.card.dataset.text;
        const opposite = lastCard.card.dataset.opposite;
        remainingQuestionsByCategory[category].push({ question, opposite });
        selectionCount--;
        const containerId = lastCard.status === 'rejected' ? 'rejected-container' : 'selected-container';
        const container = document.getElementById(containerId);
        if (container.lastChild) {
            const text = container.lastChild.dataset.text;
            const selection = allSelections.find(sel => sel.text === text && sel.status === lastCard.status);
            if (selection) {
                if (lastCard.status === 'rejected') {
                    rejectedSelections[selection.category]--;
                } else {
                    selectedSelections[selection.category]--;
                }
                allSelections.splice(allSelections.indexOf(selection), 1);
            }
            container.removeChild(container.lastChild);
        }
        lastCard.card.style.visibility = 'visible';
        lastCard.card.classList.remove('selected-card', lastCard.status, 'darkened');
        lastCard.card.style.transform = '';
        lastCard.card.style.fontSize = '16px';
        lastCard.card.style.border = 'none';
        lastCard.card.style.removeProperty('--dark-color');
        lastCard.card.querySelector('.front').style.fontWeight = 'normal';
        const cardContainer = document.getElementById('card-container');
        const isRejectPhase = cardContainer.classList.contains('rejected-phase');
        lastCard.card.querySelector('.front').innerText = isRejectPhase ? lastCard.card.dataset.opposite : lastCard.card.dataset.text;
        lastCard.card.title = isRejectPhase ? lastCard.card.dataset.text : lastCard.card.dataset.opposite;
        lastCard.card.querySelector('.front').style.backgroundColor = isRejectPhase ? REJECTED_BG : SELECTED_BG;
        instruction.innerText = CHOOSE_MOST_LIKE_YOU;
        document.getElementById('undo-button').style.display = 'block';
        const currentSetSize = Array.from(cards).filter(c => c.style.display !== 'none').length;
        document.getElementById('reverse-button').style.display = (currentSetSize - selectionCount) >= 2 ? 'block' : 'none';
    }
}
function reverseSentiment() {
    if (isAnimating || selectionCount >= 4 || (CARDS_PER_SET - selectionCount) < 2) return;
    const cardContainer = document.getElementById('card-container');
    const isRejectPhase = cardContainer.classList.contains('rejected-phase');
    cardContainer.classList.toggle('rejected-phase');
    cardContainer.classList.toggle('selected-phase');
    const remainingCards = Array.from(cards).filter(c => c.style.display !== 'none' && c.style.visibility !== 'hidden');
remainingCards.forEach(card => {
    if (!card.classList.contains('selected-card')) {
        card.querySelector('.front').innerText = isRejectPhase ? card.dataset.text : card.dataset.opposite;
        card.title = isRejectPhase ? card.dataset.opposite : card.dataset.text;
        card.querySelector('.front').style.backgroundColor = isRejectPhase ? SELECTED_BG : REJECTED_BG;
    }
});
    document.getElementById('reverse-button').style.backgroundColor = isRejectPhase ? REJECTED_BG : SELECTED_BG;
}
cards.forEach((card, index) => {
card.addEventListener('click', () => {
    if (card.style.display === 'none') return;
    if (!isFlipped) {
        flipCards();
    } else {
        if (card.classList.contains('selected-card')) {
            card.classList.toggle('darkened');
            const front = card.querySelector('.front');
            const status = card.classList.contains('selected') ? 'selected' : 'rejected';
            const isSelected = status === 'selected';
            const regularColor = isSelected ? SELECTED_BG : REJECTED_BG;
            const darkColor = isSelected ? DARKENED_SELECTED_BG : DARKENED_REJECTED_BG;
            if (card.classList.contains('darkened')) {
                front.style.backgroundColor = darkColor;
            } else {
                front.style.backgroundColor = regularColor;
            }
            const selection = allSelections.find(sel => sel.text === card.dataset.text);
            if (selection) selection.darkened = card.classList.contains('darkened');
            return;
        } else if (selectionCount < 4 && !isAnimating) {
            isAnimating = true;
            const isRejectPhase = document.getElementById('card-container').classList.contains('rejected-phase');
            const status = isRejectPhase ? 'rejected' : 'selected';
            const containerId = isRejectPhase ? 'rejected-container' : 'selected-container';
            const iconClass = isRejectPhase ? 'rejected-icon' : 'selected-icon';
            const text = card.dataset.text;
            const opposite = card.dataset.opposite;
            const category = card.dataset.category;
            if (status === 'rejected') {
                rejectedSelections[category] = (rejectedSelections[category] || 0) + 1;
            } else {
                selectedSelections[category] = (selectedSelections[category] || 0) + 1;
            }
            selectedCards.push({ card, status });
            // Apply drop, shrink, and border without animating to container yet
            card.classList.add('selected-card', status);
            card.style.transform = `translateY(${SELECTED_DROP_Y}) scale(${SELECTED_SCALE})`;
            card.style.fontSize = `${16 * SELECTED_FONT_SCALE}px`; // Adjust font size proportionally
            card.style.border = `${BORDER_WIDTH} solid ${status === 'selected' ? SELECTED_BORDER : REJECTED_BORDER}`;
            selectionCount++;
allSelections.push({ text, category, status, darkened: false });
            if (selectionCount === 1) {
                STRENGTHEN_INSTRUCTION.style.display = 'block';
            }
            setTimeout(() => { // Small delay to complete drop animation
                if (selectionCount === 4 || (selectionCount < 4 && progressContainer.children.length === 0)) {
                    setTimeout(() => { // Delay before animating all to containers
                        selectedCards.forEach(({ card, status }) => {
                            const containerId = status === 'rejected' ? 'rejected-container' : 'selected-container';
                            const iconClass = status === 'rejected' ? 'rejected-icon' : 'selected-icon';
                            const text = card.dataset.text;
                            const opposite = card.dataset.opposite;
                            const category = card.dataset.category;
                            card.style.visibility = 'hidden';
                            animateCardToContainer(card, containerId, iconClass, text, opposite, category, () => {}, card.classList.contains('darkened'));
                        });
                        const remainingCard = Array.from(cards).find(c => c.style.display !== 'none' && !c.classList.contains('selected-card'));
                        if (remainingCard) {
                            const neitherText = remainingCard.dataset.text;
                            const neitherOpposite = remainingCard.dataset.opposite;
                            const neitherCategory = remainingCard.dataset.category;
                            // Apply drop/shrink/border to remaining card before animating
                            remainingCard.classList.add('selected-card', 'grey'); // Use grey for neither, but no border color needed
                            remainingCard.style.transform = `translateY(${SELECTED_DROP_Y}) scale(${SELECTED_SCALE})`;
                            remainingCard.style.fontSize = `${16 * SELECTED_FONT_SCALE}px`;
                            setTimeout(() => {
                                remainingCard.style.visibility = 'hidden';
                                animateCardToContainer(remainingCard, 'neither-container', 'neither-icon', neitherText, neitherOpposite, neitherCategory, () => {
                                    currentSetIndex++;
                                    displaySet();
                                });
                            }, SELECTED_DROP_DELAY);
allSelections.push({ text: neitherText, category: neitherCategory, status: 'grey', darkened: false }); } else {
                            currentSetIndex++;
                            displaySet();
                        }
                        selectedCards = []; // Reset after animation
                        STRENGTHEN_INSTRUCTION.style.display = 'none'; // Hide instruction after set completes
                    }, SELECTED_DROP_DELAY);
                } else {
                    instruction.innerText = CHOOSE_MOST_LIKE_YOU;
                    document.getElementById('undo-button').style.display = 'block';
                    document.getElementById('reverse-button').style.display = (CARDS_PER_SET - selectionCount) >= 2 ? 'block' : 'none';
                    document.getElementById('reverse-button').style.backgroundColor = isRejectPhase ? SELECTED_BG : REJECTED_BG;
                    isAnimating = false;
                }
            }, 300); // Short delay for drop animation
        }
    }
});
});
document.getElementById('reverse-button').addEventListener('click', reverseSentiment);
document.getElementById('undo-button').addEventListener('click', undoRejection);
const autoProgressButton = document.getElementById('auto-progress');
autoProgressButton.addEventListener('click', () => {
    autoProgressButton.disabled = true;
    const interval = setInterval(() => {
        const instructionText = instruction.innerText.trim();
        if (progressContainer.children.length <= 2) {
            console.log('Auto Progress stopped: 2 or fewer blue boxes remaining');
            clearInterval(interval);
            return;
        }
        if (instructionText === CLICK_ANY_CARD) {
            const visibleCards = Array.from(cards).filter(c => c.style.display !== 'none');
            if (visibleCards.length > 0) visibleCards[0].click(); // Flip the first card to start
        } else if (instructionText !== CLICK_ANY_CARD) {
            const visibleCards = Array.from(cards).filter(c => c.style.display !== 'none' && c.style.visibility !== 'hidden');
            if (visibleCards.length > 0) {
                visibleCards[0].click(); // Select first card
                setTimeout(() => {
                    if (selectionCount < 4 && visibleCards.length > 1) visibleCards[1].click(); // Select second card
                    setTimeout(() => {
                        if (selectionCount < 4 && visibleCards.length > 2) visibleCards[2].click(); // Select third card
                        setTimeout(() => {
                            if (selectionCount < 4 && visibleCards.length > 3) visibleCards[3].click(); // Select fourth card
                        }, 300);
                    }, 300);
                }, 300);
            }
        } else if (instructionText.includes("When you are ready to start click continue")) {
            continueButton.click();
        } else if (instructionText === BEGIN_GAME_INSTRUCTION) {
            continueButton.click();
        } else if (instructionText.includes("Please click on Continue")) {
            console.log('Auto Progress: Clicking Continue button');
            continueButton.click();
        } else if (instructionText === ALL_SETS_COMPLETED_INSTRUCTION) {
            clearInterval(interval);
        }
    }, 300);
});
    </script>
</body>
</html>

